<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Orario Lavoro</title>
    <link rel="apple-touch-icon" href="img/apple-touch-icon.png">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f0f5;
            margin: 0;
            padding: 10px;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .logo-text {
            text-align: center;
            font-size: 2em;
            font-weight: 700;
            color: #00a2e3;
            margin-bottom: 15px;
        }
        h1, h2 {
            text-align: center;
            color: #00a2e3;
            margin-bottom: 15px;
        }
        h2 {
            margin-top: 30px;
        }
        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-bottom: 0;
            font-size: 1.2em;
        }
        .collapsible-header .arrow {
            margin-left: 8px;
            transition: transform 0.3s ease;
        }
        .collapsible-header.open .arrow {
            transform: rotate(180deg);
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }
        .collapsible-content.open {
            max-height: 2000px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 0.9em;
        }
        input[type="date"], input[type="text"], textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            transition: box-shadow 0.3s ease, border-color 0.3s ease;
        }
        
        input[type="date"]:focus, input[type="text"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #00a2e3;
            box-shadow: 0 0 0 3px rgba(0, 162, 227, 0.3);
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        .time-dropdown-container {
            position: relative;
        }
        .time-display {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            background-color: #fff;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .time-dropdown-container:focus-within .time-display {
            border-color: #00a2e3;
            box-shadow: 0 0 0 3px rgba(0, 162, 227, 0.3);
        }
        .time-display:after {
            content: '▼';
            font-size: 12px;
        }
        .time-options {
            position: absolute;
            width: 100%;
            max-height: 200px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #fff;
            z-index: 10;
            margin-top: 4px;
            display: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .time-options.visible {
            display: block;
        }
        .time-option {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .time-option:hover {
            background-color: #f0f0f5;
        }
        .time-option.selected {
            background-color: #e6f7ff;
            font-weight: 600;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .checkbox-group input {
            width: auto;
            margin-right: 8px;
            -webkit-appearance: checkbox;
        }
        .btn {
            display: block;
            width: 100%;
            padding: 12px;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .btn-small {
            padding: 5px 8px;
            font-size: 12px;
            margin: 0;
            display: inline-block;
            width: auto;
            border-radius: 6px;
        }
        
        .btn-delete {
            background-color: #f08080;
        }
        .btn-delete:hover {
            background-color: #e06666;
        }
        
        .btn-edit {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-edit:hover {
            background-color: #e0a800;
        }
        
        #save-btn {
            background-color: #00a2e3;
            font-size: 20px;
            position: relative;
        }
        #save-btn:hover {
            background-color: #007bb6;
        }

        .btn-save-anim {
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .btn-save-anim .btn-text, .btn-save-anim .btn-icon {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .btn-save-anim .btn-text {
            position: absolute;
            opacity: 1;
            transform: translateY(0);
        }
        .btn-save-anim .btn-icon {
            position: absolute;
            opacity: 0;
            transform: translateY(100%);
        }
        .btn-save-anim.saved .btn-text {
            opacity: 0;
            transform: translateY(-100%);
        }
        .btn-save-anim.saved .btn-icon {
            opacity: 1;
            transform: translateY(0);
        }
        
        .btn-green {
            background-color: #22a36b;
        }
        .btn-green:hover {
            background-color: #1a7e52;
        }

        .btn-pdf {
            background-color: #b30000;
        }
        .btn-pdf:hover {
            background-color: #800000;
        }
        
        .btn-backup {
            background-color: #337ab7;
        }
        .btn-backup:hover {
            background-color: #286090;
        }
        
        .button-group-responsive {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .button-group-responsive .btn {
            flex: 1 1 48%; /* 2 per riga con gap */
            margin-top: 0;
            box-sizing: border-box; /* Aggiunto per un controllo più preciso del layout */
        }
        
        @media (max-width: 480px) {
            .button-group-responsive .btn {
                flex: 1 1 calc(50% - 5px); /* Regolazione per schermi piccoli */
                margin-right: 5px; /* Aggiunto margine per la spaziatura */
            }
            .button-group-responsive .btn:nth-child(2n) {
                margin-right: 0; /* Rimuovi il margine dall'ultimo pulsante */
            }
        }
        
        @media (min-width: 481px) {
            .button-group-responsive .btn {
                width: 50%;
                margin-right: 5px;
                flex: none;
            }
            .button-group-responsive .btn:last-child {
                margin-right: 0;
            }
        }
        
        #results {
            margin-top: 20px;
            padding: 12px;
            background-color: #e9ecef;
            border-radius: 8px;
        }
        #results h3 {
            margin-top: 0;
            color: #00a2e3;
            font-size: 1.1em;
        }
        #results p {
            margin: 4px 0;
            font-size: 16px;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: #fff;
            font-size: 12px;
        }
        th, td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            white-space: nowrap;
        }
        th:last-child {
            text-align: center;
        }
        td:first-child {
            white-space: nowrap;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        /* Animazione per le righe del registro */
        #register-table tbody tr {
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInRow 0.5s ease-out forwards;
        }
        @keyframes fadeInRow {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .action-buttons-cell {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }
        #notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            opacity: 0;
            transform: translateY(100px);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        #notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        #notification.success {
            background-color: #28a745;
        }
        #notification.error {
            background-color: #dc3545;
        }
        
        .export-options-container {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: flex-start;
        }
        
        .export-options-container > select {
            width: 45%; 
        }
        .export-options-container > .multiselect-dropdown {
            width: 45%;
        }
        
        select {
            padding: 0 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: #fff;
            height: 40px;
        }
        
        /* Multiselect dropdown */
        .multiselect-dropdown {
            position: relative;
            cursor: pointer;
            user-select: none;
        }
        .multiselect-selected {
            width: 100%;
            padding: 0 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #fff;
            height: 40px;
            font-size: 14px;
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
            gap: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            line-height: 40px;
            transition: box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .multiselect-selected:after {
            content: '▼';
            font-size: 12px;
            margin-left: auto;
            flex-shrink: 0;
        }
        .multiselect-options {
            position: absolute;
            width: 100%;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #fff;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
            box-sizing: border-box;
        }
        .multiselect-options.visible {
            display: block;
        }
        .multiselect-option {
            padding: 10px;
            display: flex;
            align-items: center;
        }
        .multiselect-option input[type="checkbox"] {
            margin-right: 10px;
            -webkit-appearance: checkbox;
        }
        .multiselect-option:hover {
            background-color: #f0f0f5;
        }
        .multiselect-dropdown.disabled {
            opacity: 0.6;
            pointer-events: none;
        }
        @media (min-width: 600px) {
            .multiselect-selected,
            .export-options-container > select {
                font-size: 16px;
                height: 48px;
                line-height: 48px;
            }
            .multiselect-option {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="logo-text">TECNOSISTEM</div>
    <div class="form-group">
        <label for="date">Seleziona Giorno:</label>
        <input type="date" id="date">
    </div>
    <div class="form-group">
        <label>Orario Inizio:</label>
        <div class="time-dropdown-container">
            <div id="startTimeDisplay" class="time-display" data-value="">Seleziona orario</div>
            <div id="startTimeOptions" class="time-options"></div>
        </div>
    </div>
    <div class="form-group">
        <label>Orario Fine:</label>
        <div class="time-dropdown-container">
            <div id="endTimeDisplay" class="time-display" data-value="">Seleziona orario</div>
            <div id="endTimeOptions" class="time-options"></div>
        </div>
    </div>
    <div class="checkbox-group">
        <input type="checkbox" id="lunchBreak">
        <label for="lunchBreak">Pausa pranzo (1 ora)</label>
    </div>
    <div class="checkbox-group">
        <input type="checkbox" id="businessTrip">
        <label for="businessTrip">In trasferta</label>
    </div>
    <div class="checkbox-group">
        <input type="checkbox" id="onSite">
        <label for="onSite">In sede</label>
    </div>
    <div class="form-group">
        <label for="location">Luogo Intervento:</label>
        <input type="text" id="location" list="location-suggestions">
        <datalist id="location-suggestions"></datalist>
    </div>
    <div class="form-group">
        <label for="notes">Note:</label>
        <textarea id="notes"></textarea>
    </div>

    <div id="results">
        <h3>Riepilogo giornaliero</h3>
        <p><strong>Ore totali:</strong> <span id="totalHours">0</span></p>
        <p><strong>Ore straordinarie:</strong> <span id="overtimeHours">0</span></p>
    </div>
    
    <button id="save-btn" class="btn btn-save-anim">
        <span class="btn-text">💾 Salva</span>
        <span class="btn-icon">✅</span>
    </button>
    
    <div class="form-group" style="margin-top: 20px;">
        <label for="export-month-year">Esporta per Mese(i) o Anno:</label>
        <div class="export-options-container">
            <select id="export-year">
                <option value="">Seleziona Anno</option>
            </select>
            <div class="multiselect-dropdown" id="multiselect-month-container">
                <div class="multiselect-selected">Seleziona Mese(i)</div>
                <div class="multiselect-options" id="multiselect-month-options"></div>
            </div>
        </div>
    </div>
    <div class="button-group-responsive">
        <button id="export-selected-btn" class="btn btn-green">CSV</button>
        <button id="export-selected-pdf-btn" class="btn btn-pdf">PDF 📄</button>
    </div>
    <div class="button-group-responsive">
        <button id="export-all-btn" class="btn btn-green">Completo CSV</button>
        <button id="export-pdf-btn" class="btn btn-pdf">Completo PDF 📄</button>
    </div>
    <div class="button-group-responsive" style="margin-top: 5px;">
        <button id="export-data-btn" class="btn btn-backup">Salva Backup</button>
        <button id="import-data-btn" class="btn btn-backup" type="button">Carica Backup</button>
        <input type="file" id="import-file" accept=".json" style="display:none;">
    </div>

    <h2>Riepilogo Mensile</h2>
    <div class="table-container">
        <table id="monthly-summary-table">
            <thead>
                <tr>
                    <th>Mese</th>
                    <th>Ore Tot.</th>
                    <th>Ore Str.</th>
                    <th>Trasf.</th>
                    <th>Sede</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>
    
    <div class="form-group" style="margin-top: 20px;">
        <label for="search-input">Cerca nel registro:</label>
        <input type="text" id="search-input" placeholder="Cerca per data, luogo o note...">
    </div>
    
    <h2 class="collapsible-header" id="toggle-register">Registro Completo <span class="arrow">▼</span></h2>
    <div class="collapsible-content" id="register-content">
        <div class="form-group" style="margin-top: 20px;">
            <label for="filter-month-year">Filtra per Mese(i) o Anno:</label>
            <div class="export-options-container">
                <select id="filter-year">
                    <option value="">Tutti gli Anni</option>
                </select>
                <div class="multiselect-dropdown" id="filter-month-container">
                    <div class="multiselect-selected">Tutti i Mesi</div>
                    <div class="multiselect-options" id="filter-month-options"></div>
                </div>
            </div>
        </div>
        <div class="table-container">
            <table id="register-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Inizio</th>
                        <th>Fine</th>
                        <th>Totali</th>
                        <th>Str.</th>
                        <th>Trasf.</th>
                        <th>Sede</th>
                        <th>Luogo</th>
                        <th>Note</th>
                        <th>Azione</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>
</div>

<div id="notification"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script>
    const dateInput = document.getElementById('date');
    const startTimeDisplay = document.getElementById('startTimeDisplay');
    const startTimeOptions = document.getElementById('startTimeOptions');
    const endTimeDisplay = document.getElementById('endTimeDisplay');
    const endTimeOptions = document.getElementById('endTimeOptions');
    const lunchBreakCheckbox = document.getElementById('lunchBreak');
    const businessTripCheckbox = document.getElementById('businessTrip');
    const onSiteCheckbox = document.getElementById('onSite');
    const locationInput = document.getElementById('location');
    const notesInput = document.getElementById('notes');
    const totalHoursSpan = document.getElementById('totalHours');
    const overtimeHoursSpan = document.getElementById('overtimeHours');
    const saveButton = document.getElementById('save-btn');
    const registerBody = document.querySelector('#register-table tbody');
    const monthlySummaryBody = document.querySelector('#monthly-summary-table tbody');
    const locationDatalist = document.getElementById('location-suggestions');
    const toggleRegisterHeader = document.getElementById('toggle-register');
    const registerContent = document.getElementById('register-content');
    const notification = document.getElementById('notification');
    const searchInput = document.getElementById('search-input');
    const standardWorkDay = 8;
    let registerData = [];
    
    const exportYearSelect = document.getElementById('export-year');
    const multiselectMonthContainer = document.getElementById('multiselect-month-container');
    const multiselectMonthSelected = document.querySelector('#multiselect-month-container .multiselect-selected');
    const multiselectMonthOptions = document.getElementById('multiselect-month-options');
    const exportSelectedButton = document.getElementById('export-selected-btn');
    const exportSelectedPdfButton = document.getElementById('export-selected-pdf-btn');
    const exportAllButton = document.getElementById('export-all-btn');
    const exportPdfButton = document.getElementById('export-pdf-btn');

    const filterYearSelect = document.getElementById('filter-year');
    const filterMonthContainer = document.getElementById('filter-month-container');
    const filterMonthSelected = document.querySelector('#filter-month-container .multiselect-selected');
    const filterMonthOptions = document.getElementById('filter-month-options');

    const exportDataBtn = document.getElementById('export-data-btn');
    const importDataBtn = document.getElementById('import-data-btn');
    const importFile = document.getElementById('import-file');


    function showNotification(message, type) {
        notification.innerHTML = message;
        notification.className = '';
        notification.classList.add('show', type);
        setTimeout(() => {
            notification.classList.remove('show');
        }, 8000); 
    }

    function generateTimeOptions() {
        let optionsHtml = '';
        for (let h = 0; h < 24; h++) {
            for (let m = 0; m < 60; m += 30) {
                const hour = String(h).padStart(2, '0');
                const minute = String(m).padStart(2, '0');
                const time = `${hour}:${minute}`;
                optionsHtml += `<div class="time-option" data-value="${time}">${time}</div>`;
            }
        }
        startTimeOptions.innerHTML = optionsHtml;
        endTimeOptions.innerHTML = optionsHtml;
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        const [year, month, day] = dateString.split('-');
        if (year && year.length >= 2) {
            return `${day}-${month}-${year.substring(2)}`;
        }
        return dateString;
    }

    function calculateHours() {
        const startTime = startTimeDisplay.getAttribute('data-value');
        const endTime = endTimeDisplay.getAttribute('data-value');
        const lunchBreak = lunchBreakCheckbox.checked;
        if (startTime && endTime) {
            const start = new Date(`2025-01-01T${startTime}:00`);
            const end = new Date(`2025-01-01T${endTime}:00`);
            if (end < start) {
                end.setDate(end.getDate() + 1);
            }
            let totalMilliseconds = end - start;
            let totalHours = totalMilliseconds / (1000 * 60 * 60);
            if (lunchBreak) {
                totalHours -= 1;
            }
            const totalHoursFixed = totalHours.toFixed(2);
            let overtimeHours = 0;
            if (totalHours > standardWorkDay) {
                overtimeHours = totalHours - standardWorkDay;
            }
            totalHoursSpan.textContent = totalHoursFixed;
            overtimeHoursSpan.textContent = overtimeHours.toFixed(2);
        } else {
            totalHoursSpan.textContent = '0';
            overtimeHoursSpan.textContent = '0';
        }
    }

    function createRow(entry) {
        const row = document.createElement('tr');
        row.setAttribute('data-date', entry.date);
        row.innerHTML = `
            <td>${formatDate(entry.date)}</td>
            <td>${entry.startTime}</td>
            <td>${entry.endTime}</td>
            <td>${entry.totalHours.toFixed(2)}</td>
            <td>${entry.overtimeHours.toFixed(2)}</td>
            <td>${entry.businessTrip ? 'Sì' : 'No'}</td>
            <td>${entry.onSite ? 'Sì' : 'No'}</td>
            <td>${entry.location}</td>
            <td>${entry.notes || ''}</td>
            <td class="action-buttons-cell">
                <button class="btn-small btn-edit" data-date="${entry.date}">✏️</button>
                <button class="btn-small btn-delete" data-date="${entry.date}">🗑️</button>
            </td>
        `;
        return row;
    }

    function saveEntry() {
        const date = dateInput.value;
        const startTime = startTimeDisplay.getAttribute('data-value');
        const endTime = endTimeDisplay.getAttribute('data-value');
        const lunchBreak = lunchBreakCheckbox.checked;
        const businessTrip = businessTripCheckbox.checked;
        const onSite = onSiteCheckbox.checked;
        const location = locationInput.value;
        const notes = notesInput.value;
        const totalHours = parseFloat(totalHoursSpan.textContent);
        const overtimeHours = parseFloat(overtimeHoursSpan.textContent);
        
        if (!date || !startTime || !endTime) {
            showNotification('Per favore, compila tutti i campi obbligatori.', 'error');
            return;
        }
        const start = new Date(`2025-01-01T${startTime}:00`);
        const end = new Date(`2025-01-01T${endTime}:00`);
        if (end < start) {
            showNotification('L\'orario di fine non può essere precedente a quello di inizio.', 'error');
            return;
        }

        saveButton.classList.add('saved');

        const newEntry = {
            date: date,
            startTime: startTime,
            endTime: endTime,
            totalHours: totalHours,
            overtimeHours: overtimeHours,
            businessTrip: businessTrip,
            onSite: onSite,
            lunchBreak: lunchBreak,
            location: location,
            notes: notes
        };
        const existingIndex = registerData.findIndex(entry => entry.date === date);
        if (existingIndex !== -1) {
            registerData[existingIndex] = newEntry;
        } else {
            registerData.push(newEntry);
        }
        registerData.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        try {
            localStorage.setItem('registroOrario', JSON.stringify(registerData));
        } catch (e) {
            showNotification('ERRORE: Impossibile salvare i dati.', 'error');
            console.error(e);
            return;
        }
        renderRegister();
        renderMonthlySummary();
        updateLocationSuggestions();
        updateExportAndFilterOptions();
        showNotification('Dati salvati nel registro!', 'success');
        
        setTimeout(() => {
            saveButton.classList.remove('saved');
            dateInput.value = '';
            startTimeDisplay.textContent = 'Seleziona orario';
            startTimeDisplay.setAttribute('data-value', '');
            endTimeDisplay.textContent = 'Seleziona orario';
            endTimeDisplay.setAttribute('data-value', '');
            lunchBreakCheckbox.checked = false;
            businessTripCheckbox.checked = false;
            onSiteCheckbox.checked = false;
            locationInput.value = '';
            notesInput.value = '';
            locationInput.disabled = false;
            calculateHours();
        }, 1000);
    }

    function deleteEntry(date) {
        if (confirm(`Sei sicuro di voler cancellare l'inserimento del giorno ${formatDate(date)}?`)) {
            registerData = registerData.filter(entry => entry.date !== date);
            localStorage.setItem('registroOrario', JSON.stringify(registerData));
            renderRegister();
            renderMonthlySummary();
            updateLocationSuggestions();
            updateExportAndFilterOptions();
            showNotification(`Inserimento per il giorno ${formatDate(date)} cancellato.`, 'success');
        }
    }

    function editEntry(date) {
        const entryToEdit = registerData.find(entry => entry.date === date);
        if (entryToEdit) {
            dateInput.value = entryToEdit.date;
            startTimeDisplay.textContent = entryToEdit.startTime;
            startTimeDisplay.setAttribute('data-value', entryToEdit.startTime);
            endTimeDisplay.textContent = entryToEdit.endTime;
            endTimeDisplay.setAttribute('data-value', entryToEdit.endTime);
            lunchBreakCheckbox.checked = entryToEdit.lunchBreak;
            businessTripCheckbox.checked = entryToEdit.businessTrip;
            onSiteCheckbox.checked = entryToEdit.onSite;
            locationInput.value = entryToEdit.location;
            notesInput.value = entryToEdit.notes || '';
            calculateHours();
            window.scrollTo(0, 0);
            if (onSiteCheckbox.checked) {
                locationInput.value = 'Tecnosistem';
                locationInput.disabled = true;
            } else {
                locationInput.disabled = false;
            }
        }
    }

    function renderRegister(dataToRender = registerData) {
        registerBody.innerHTML = '';
        dataToRender.forEach(entry => {
            const row = createRow(entry);
            registerBody.appendChild(row);
        });
        registerBody.querySelectorAll('.btn-edit').forEach(button => {
            button.addEventListener('click', (e) => editEntry(e.target.dataset.date));
        });
        registerBody.querySelectorAll('.btn-delete').forEach(button => {
            button.addEventListener('click', (e) => deleteEntry(e.target.dataset.date));
        });
    }

    function renderMonthlySummary() {
        monthlySummaryBody.innerHTML = '';
        const summary = {};
        registerData.forEach(entry => {
            const date = new Date(entry.date);
            const monthKey = date.getFullYear() + '-' + date.getMonth();
            const monthName = date.toLocaleString('it-IT', { month: 'long' });
            if (!summary[monthKey]) {
                summary[monthKey] = {
                    monthName: monthName.charAt(0).toUpperCase() + monthName.slice(1),
                    totalHours: 0,
                    overtimeHours: 0,
                    businessTripDays: 0,
                    onSiteDays: 0
                };
            }
            summary[monthKey].totalHours += parseFloat(entry.totalHours) || 0;
            summary[monthKey].overtimeHours += parseFloat(entry.overtimeHours) || 0;
            if (entry.businessTrip) {
                summary[monthKey].businessTripDays += 1;
            }
            if (entry.onSite) {
                summary[monthKey].onSiteDays += 1;
            }
        });
        const sortedMonths = Object.keys(summary).sort((a, b) => {
            const [yearA, monthA] = a.split('-').map(Number);
            const [yearB, monthB] = b.split('-').map(Number);
            if (yearA !== yearB) return yearA - yearB;
            return monthA - monthB;
        });
        sortedMonths.forEach(monthKey => {
            const monthSummary = summary[monthKey];
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${monthSummary.monthName}</td>
                <td>${monthSummary.totalHours.toFixed(2)}</td>
                <td>${monthSummary.overtimeHours.toFixed(2)}</td>
                <td>${monthSummary.businessTripDays}</td>
                <td>${monthSummary.onSiteDays}</td>
            `;
            monthlySummaryBody.appendChild(row);
        });
    }

    function updateLocationSuggestions() {
        const uniqueLocations = [...new Set(registerData.map(entry => entry.location).filter(Boolean))];
        locationDatalist.innerHTML = uniqueLocations.map(location => `<option value="${location}">`).join('');
    }

    function exportToCsv(data, filename) {
        data.sort((a, b) => new Date(b.date) - new Date(a.date));

        let csvContent = "";
        let currentMonth = null;
        let currentYear = null;

        data.forEach(entry => {
            const entryDate = new Date(entry.date);
            const entryMonth = entryDate.getMonth();
            const entryYear = entryDate.getFullYear();

            if (entryMonth !== currentMonth || entryYear !== currentYear) {
                const monthName = entryDate.toLocaleString('it-IT', { month: 'long', year: 'numeric' });
                csvContent += `\n**--- Mese di ${monthName.charAt(0).toUpperCase() + monthName.slice(1)} ---**\n`;
                csvContent += "Data,Orario inizio,Orario fine,Ore totali,Ore straordinarie,Trasferta,Sede,Luogo,Note\n";
                currentMonth = entryMonth;
                currentYear = entryYear;
            }

            const row = `${formatDate(entry.date)},${entry.startTime},${entry.endTime},${entry.totalHours},${entry.overtimeHours},${entry.businessTrip ? 'Sì' : 'No'},${entry.onSite ? 'Sì' : 'No'},"${entry.location.replace(/"/g, '""')}", "${(entry.notes || '').replace(/"/g, '""')}"`;
            csvContent += row + '\n';
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    function generatePdfFromData(data, filename) {
        if (data.length === 0) {
            showNotification('Nessun dato da esportare.', 'error');
            return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const dataForPdf = [...data].sort((a, b) => new Date(b.date) - new Date(a.date));

        const tableColumn = ["Data", "Inizio", "Fine", "Ore Tot.", "Ore Str.", "Trasf.", "Sede", "Luogo", "Note"];
        
        let groupedData = {};
        dataForPdf.forEach(entry => {
            const monthKey = new Date(entry.date).toLocaleString('it-IT', { year: 'numeric', month: 'long' });
            if (!groupedData[monthKey]) {
                groupedData[monthKey] = [];
            }
            groupedData[monthKey].push(entry);
        });

        const sortedMonths = Object.keys(groupedData).sort((a, b) => new Date(b) - new Date(a));
        
        let startY = 20;

        sortedMonths.forEach(monthKey => {
            const monthData = groupedData[monthKey];
            if (doc.internal.pageSize.height - startY < 30) {
                doc.addPage();
                startY = 20;
            }
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text(`Mese di ${monthKey.charAt(0).toUpperCase() + monthKey.slice(1)}`, 105, startY, null, null, "center");
            
            const tableRows = monthData.map(entry => [
                formatDate(entry.date),
                entry.startTime,
                entry.endTime,
                entry.totalHours.toFixed(2),
                entry.overtimeHours.toFixed(2),
                entry.businessTrip ? 'Sì' : 'No',
                entry.onSite ? 'Sì' : 'No',
                entry.location,
                entry.notes || ''
            ]);

            doc.autoTable({
                startY: startY + 5,
                head: [tableColumn],
                body: tableRows,
                theme: 'striped',
                headStyles: { fillColor: [0, 162, 227] },
                didDrawPage: (data) => {
                    if (data.pageNumber > 1) {
                         doc.setFontSize(10);
                         doc.text("Pagina " + doc.internal.getNumberOfPages(), data.settings.margin.left, doc.internal.pageSize.height - 10);
                    }
                }
            });
            startY = doc.lastAutoTable.finalY + 10;
        });

        doc.save(filename);
        showNotification(`**${filename}** generato e salvato!`, 'success');
    }

    function exportSelectedToCsv() {
        const selectedYear = exportYearSelect.value;
        const selectedMonths = Array.from(multiselectMonthOptions.querySelectorAll('input:checked')).map(checkbox => parseInt(checkbox.value));
        
        let filteredData = registerData;
        let filename = 'registro_orario_selezionato.csv';

        if (selectedYear) {
            filteredData = filteredData.filter(entry => new Date(entry.date).getFullYear() == selectedYear);
            filename = `registro_${selectedYear}.csv`;
        }
        
        if (selectedMonths.length > 0) {
            filteredData = filteredData.filter(entry => {
                const entryMonth = new Date(entry.date).getMonth();
                const entryYear = new Date(entry.date).getFullYear();
                return selectedMonths.includes(entryMonth) && (!selectedYear || entryYear == selectedYear);
            });
            const monthNames = selectedMonths.map(m => new Date(2000, m).toLocaleString('it-IT', { month: 'short' }));
            filename = `registro_${monthNames.join('-')}_${selectedYear || 'tutti_gli_anni'}.csv`;
        }
        
        if (filteredData.length > 0) {
            exportToCsv(filteredData, filename);
            showNotification('Dati selezionati esportati con successo!', 'success');
        } else {
            showNotification('Nessun dato da esportare per la selezione corrente.', 'error');
        }
    }
    
    function exportSelectedToPdf() {
        const selectedYear = exportYearSelect.value;
        const selectedMonths = Array.from(multiselectMonthOptions.querySelectorAll('input:checked')).map(checkbox => parseInt(checkbox.value));
        
        let filteredData = registerData;
        let filename = 'registro_orario_selezionato.pdf';

        if (!selectedYear && selectedMonths.length === 0) {
             showNotification('Seleziona un anno o almeno un mese per l\'esportazione.', 'error');
             return;
        }
        
        if (selectedYear) {
            filteredData = filteredData.filter(entry => new Date(entry.date).getFullYear() == selectedYear);
            const yearText = `_${selectedYear}`;
            filename = `registro${yearText}.pdf`;
        }
        
        if (selectedMonths.length > 0) {
            filteredData = filteredData.filter(entry => {
                const entryMonth = new Date(entry.date).getMonth();
                const entryYear = new Date(entry.date).getFullYear();
                return selectedMonths.includes(entryMonth) && (!selectedYear || entryYear == selectedYear);
            });
            const monthNames = selectedMonths.map(m => new Date(2000, m).toLocaleString('it-IT', { month: 'short' }));
            const yearText = selectedYear ? `_${selectedYear}` : '';
            filename = `registro_${monthNames.join('-')}${yearText}.pdf`;
        }
        
        if (filteredData.length > 0) {
            generatePdfFromData(filteredData, filename);
        } else {
            showNotification('Nessun dato da esportare per la selezione corrente.', 'error');
        }
    }

    function exportAllToCsv() {
        exportToCsv(registerData, 'registro_orario_completo.csv');
        showNotification('Registro completo esportato con successo!', 'success');
    }
    
    function exportAllToPdf() {
        if (registerData.length > 0) {
            const filename = 'registro_orario_completo.pdf';
            generatePdfFromData(registerData, filename);
        } else {
            showNotification('Nessun dato da esportare.', 'error');
        }
    }

    // Funzioni per il backup JSON
    function downloadJSON() {
        const dataStr = JSON.stringify(registerData, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'registro_orario_backup.json';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        showNotification('Dati salvati in file JSON!', 'success');
    }

    function uploadJSON(event) {
        const file = event.target.files[0];
        if (!file) {
            return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                if (importedData && Array.isArray(importedData)) {
                    registerData = importedData;
                    localStorage.setItem('registroOrario', JSON.stringify(registerData));
                    loadRegister();
                    showNotification('Dati ripristinati da file JSON!', 'success');
                } else {
                    showNotification('Formato file non valido.', 'error');
                }
            } catch (error) {
                showNotification('Errore nella lettura del file.', 'error');
                console.error(error);
            }
        };
        reader.readAsText(file);
    }
    
    function updateExportAndFilterOptions() {
        const uniqueYears = [...new Set(registerData.map(entry => new Date(entry.date).getFullYear()))].sort((a, b) => b - a);
        exportYearSelect.innerHTML = '<option value="">Seleziona Anno</option>' + uniqueYears.map(year => `<option value="${year}">${year}</option>`).join('');
        filterYearSelect.innerHTML = '<option value="">Tutti gli Anni</option>' + uniqueYears.map(year => `<option value="${year}">${year}</option>`).join('');
        
        const allMonths = [...new Set(registerData.map(entry => new Date(entry.date).getMonth()))].sort((a, b) => b - a);
        
        multiselectMonthOptions.innerHTML = '';
        filterMonthOptions.innerHTML = '';
        allMonths.forEach(monthIndex => {
            const monthName = new Date(2000, monthIndex).toLocaleString('it-IT', { month: 'long' });
            const optionDivExport = document.createElement('div');
            optionDivExport.className = 'multiselect-option';
            optionDivExport.innerHTML = `<input type="checkbox" value="${monthIndex}" id="export-month-${monthIndex}"> <label for="export-month-${monthIndex}">${monthName.charAt(0).toUpperCase() + monthName.slice(1)}</label>`;
            multiselectMonthOptions.appendChild(optionDivExport);

            const optionDivFilter = document.createElement('div');
            optionDivFilter.className = 'multiselect-option';
            optionDivFilter.innerHTML = `<input type="checkbox" value="${monthIndex}" id="filter-month-${monthIndex}"> <label for="filter-month-${monthIndex}">${monthName.charAt(0).toUpperCase() + monthName.slice(1)}</label>`;
            filterMonthOptions.appendChild(optionDivFilter);
        });
        updateMultiselectSelectedText(multiselectMonthOptions, multiselectMonthSelected);
        updateMultiselectSelectedText(filterMonthOptions, filterMonthSelected, 'Tutti i Mesi');
    }

    function updateMultiselectSelectedText(optionsContainer, selectedDisplay, defaultText = 'Seleziona Mese(i)') {
        const checkboxes = optionsContainer.querySelectorAll('input[type="checkbox"]');
        const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
        if (selectedCount === 0) {
            selectedDisplay.textContent = defaultText;
        } else if (selectedCount === 1) {
            const selectedLabel = optionsContainer.querySelector('input:checked + label').textContent;
            selectedDisplay.textContent = selectedLabel;
        } else {
            const selectedLabels = Array.from(checkboxes).filter(cb => cb.checked).map(cb => optionsContainer.querySelector(`label[for="${cb.id}"]`).textContent);
            selectedDisplay.textContent = selectedLabels.join(', ');
        }
    }
    
    function toggleMonthDropdown(e, container, options) {
        e.stopPropagation();
        if (!container.classList.contains('disabled')) {
            options.classList.toggle('visible');
        }
    }

    function handleYearChange(yearSelect, monthContainer, monthOptions) {
        const selectedYear = yearSelect.value;
        if (selectedYear) {
            monthContainer.classList.remove('disabled');
        } else {
            monthContainer.classList.add('disabled');
            monthOptions.classList.remove('visible');
            monthOptions.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        }
    }

    function applyFiltersAndSearch() {
        const filterYear = filterYearSelect.value;
        const filterMonths = Array.from(filterMonthOptions.querySelectorAll('input:checked')).map(checkbox => parseInt(checkbox.value));
        const searchTerm = searchInput.value.toLowerCase();
        
        let filteredData = registerData.filter(entry => {
            const entryDate = new Date(entry.date);
            const entryYear = entryDate.getFullYear();
            const entryMonth = entryDate.getMonth();
            const formattedDate = formatDate(entry.date).toLowerCase();
            const location = entry.location.toLowerCase();
            const notes = (entry.notes || '').toLowerCase();
            
            const matchesYear = !filterYear || entryYear == filterYear;
            const matchesMonth = filterMonths.length === 0 || filterMonths.includes(entryMonth);
            const matchesSearch = formattedDate.includes(searchTerm) || location.includes(searchTerm) || notes.includes(searchTerm);
            
            return matchesYear && matchesMonth && matchesSearch;
        });
        renderRegister(filteredData);
    }
    
    multiselectMonthContainer.addEventListener('click', (e) => toggleMonthDropdown(e, multiselectMonthContainer, multiselectMonthOptions));
    multiselectMonthOptions.addEventListener('change', (e) => {
        if (e.target.type === 'checkbox') {
            updateMultiselectSelectedText(multiselectMonthOptions, multiselectMonthSelected);
        }
    });
    exportYearSelect.addEventListener('change', () => {
        handleYearChange(exportYearSelect, multiselectMonthContainer, multiselectMonthOptions);
        updateMultiselectSelectedText(multiselectMonthOptions, multiselectMonthSelected);
    });

    filterMonthContainer.addEventListener('click', (e) => toggleMonthDropdown(e, filterMonthContainer, filterMonthOptions));
    filterMonthOptions.addEventListener('change', (e) => {
        if (e.target.type === 'checkbox') {
            updateMultiselectSelectedText(filterMonthOptions, filterMonthSelected, 'Tutti i Mesi');
            applyFiltersAndSearch();
        }
    });
    filterYearSelect.addEventListener('change', () => {
        handleYearChange(filterYearSelect, filterMonthContainer, filterMonthOptions);
        updateMultiselectSelectedText(filterMonthOptions, filterMonthSelected, 'Tutti i Mesi');
        applyFiltersAndSearch();
    });

    searchInput.addEventListener('input', applyFiltersAndSearch);

    function toggleRegister() {
        registerContent.classList.toggle('open');
        toggleRegisterHeader.classList.toggle('open');
    }

    function loadRegister() {
        const savedData = localStorage.getItem('registroOrario');
        if (savedData) {
            registerData = JSON.parse(savedData);
            registerData = registerData.map(entry => ({
                ...entry,
                totalHours: parseFloat(entry.totalHours) || 0,
                overtimeHours: parseFloat(entry.overtimeHours) || 0,
                lunchBreak: entry.lunchBreak === true,
                businessTrip: entry.businessTrip === true,
                onSite: entry.onSite === true,
                notes: entry.notes || ''
            }));
            registerData.sort((a, b) => new Date(b.date) - new Date(a.date));
            renderRegister();
            renderMonthlySummary();
            updateLocationSuggestions();
            updateExportAndFilterOptions();
        }
    }

    function closeAllDropdowns() {
        startTimeOptions.classList.remove('visible');
        endTimeOptions.classList.remove('visible');
        multiselectMonthOptions.classList.remove('visible');
        filterMonthOptions.classList.remove('visible');
    }

    startTimeDisplay.addEventListener('click', (event) => {
        event.stopPropagation();
        startTimeOptions.classList.toggle('visible');
        endTimeOptions.classList.remove('visible');
        multiselectMonthOptions.classList.remove('visible');
        filterMonthOptions.classList.remove('visible');
    });

    endTimeDisplay.addEventListener('click', (event) => {
        event.stopPropagation();
        endTimeOptions.classList.toggle('visible');
        startTimeOptions.classList.remove('visible');
        multiselectMonthOptions.classList.remove('visible');
        filterMonthOptions.classList.remove('visible');
    });

    startTimeOptions.addEventListener('click', (event) => {
        if (event.target.classList.contains('time-option')) {
            startTimeDisplay.textContent = event.target.getAttribute('data-value');
            startTimeDisplay.setAttribute('data-value', event.target.getAttribute('data-value'));
            startTimeOptions.classList.remove('visible');
            calculateHours();
        }
    });
    endTimeOptions.addEventListener('click', (event) => {
        if (event.target.classList.contains('time-option')) {
            endTimeDisplay.textContent = event.target.getAttribute('data-value');
            endTimeDisplay.setAttribute('data-value', event.target.getAttribute('data-value'));
            endTimeOptions.classList.remove('visible');
            calculateHours();
        }
    });
    document.addEventListener('click', (event) => {
        if (!event.target.closest('.multiselect-dropdown') && !event.target.closest('.time-dropdown-container')) {
            closeAllDropdowns();
        }
    });
    lunchBreakCheckbox.addEventListener('change', calculateHours);
    saveButton.addEventListener('click', saveEntry);
    exportSelectedButton.addEventListener('click', exportSelectedToCsv);
    exportSelectedPdfButton.addEventListener('click', exportSelectedToPdf);
    exportAllButton.addEventListener('click', exportAllToCsv);
    exportPdfButton.addEventListener('click', exportAllToPdf);
    toggleRegisterHeader.addEventListener('click', toggleRegister);
    exportDataBtn.addEventListener('click', downloadJSON);
    importDataBtn.addEventListener('click', () => importFile.click());
    importFile.addEventListener('change', uploadJSON);
    
    // Assicurarsi che solo una delle due checkbox sia selezionata alla volta
    businessTripCheckbox.addEventListener('change', () => {
        if (businessTripCheckbox.checked) {
            onSiteCheckbox.checked = false;
        }
    });
    onSiteCheckbox.addEventListener('change', () => {
        if (onSiteCheckbox.checked) {
            businessTripCheckbox.checked = false;
        }
    });
    
    onSiteCheckbox.addEventListener('change', () => {
        if (onSiteCheckbox.checked) {
            locationInput.value = 'Tecnosistem';
            locationInput.disabled = true;
        } else {
            locationInput.value = '';
            locationInput.disabled = false;
        }
    });
    
    // Imposta la data di default su quella odierna
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    dateInput.value = `${year}-${month}-${day}`;

    generateTimeOptions();
    loadRegister();
</script>
</body>
</html>
