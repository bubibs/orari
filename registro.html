<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Orario Lavoro</title>
    <link rel="apple-touch-icon" href="img/apple-touch-icon.png">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f0f5;
            margin: 0;
            padding: 10px;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .logo-text {
            text-align: center;
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 15px;
            background: linear-gradient(to right, #ef5350, #f48fb1, #7e57c2, #2196f3, #26c6da, #43a047, #eeff41, #f9a825, #ff5722);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        h1, h2 {
            text-align: center;
            color: #00a2e3;
            margin-bottom: 15px;
        }
        h2 {
            margin-top: 30px;
        }
        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-bottom: 0;
            font-size: 1.2em;
        }
        .collapsible-header .arrow {
            margin-left: 8px;
            transition: transform 0.3s ease;
        }
        .collapsible-header.open .arrow {
            transform: rotate(180deg);
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }
        .collapsible-content.open {
            max-height: 2000px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 0.9em;
        }
        input[type="date"], input[type="text"], input[type="number"], textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            transition: box-shadow 0.3s ease, border-color 0.3s ease;
        }
        input[type="date"]:focus, input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #00a2e3;
            box-shadow: 0 0 0 3px rgba(0, 162, 227, 0.3);
        }
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        .time-dropdown-container {
            position: relative;
        }
        .time-display {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            background-color: #fff;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .time-dropdown-container:focus-within .time-display {
            border-color: #00a2e3;
            box-shadow: 0 0 0 3px rgba(0, 162, 227, 0.3);
        }
        .time-display:after {
            content: '▼';
            font-size: 12px;
        }
        .time-options {
            position: absolute;
            width: 100%;
            max-height: 200px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #fff;
            z-index: 10;
            margin-top: 4px;
            display: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .time-options.visible {
            display: block;
        }
        .time-option {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .time-option:hover {
            background-color: #f0f0f5;
        }
        .time-option.selected {
            background-color: #e6f7ff;
            font-weight: 600;
        }
        .radio-group, .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .radio-group label, .checkbox-group label {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 0;
        }
        .radio-group input, .checkbox-group input {
            width: auto;
            margin-right: 8px;
            -webkit-appearance: radio;
            -moz-appearance: radio;
            appearance: radio;
        }
        .btn {
            display: block;
            width: 100%;
            padding: 12px;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        .btn-small {
            padding: 5px 8px;
            font-size: 12px;
            margin: 0;
            display: inline-block;
            width: auto;
            border-radius: 6px;
        }
        .btn-delete {
            background-color: #f08080;
        }
        .btn-delete:hover {
            background-color: #e06666;
        }
        .btn-edit {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-edit:hover {
            background-color: #e0a800;
        }
        #save-btn {
            background-color: #00a2e3;
            font-size: 20px;
            position: relative;
        }
        #save-btn:hover {
            background-color: #007bb6;
        }
        .btn-save-anim {
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .btn-save-anim .btn-text, .btn-save-anim .btn-icon {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .btn-save-anim .btn-text {
            position: absolute;
            opacity: 1;
            transform: translateY(0);
        }
        .btn-save-anim .btn-icon {
            position: absolute;
            opacity: 0;
            transform: translateY(100%);
        }
        .btn-save-anim.saved .btn-text {
            opacity: 0;
            transform: translateY(-100%);
        }
        .btn-save-anim.saved .btn-icon {
            opacity: 1;
            transform: translateY(0);
        }
        .btn-green {
            background-color: #22a36b;
        }
        .btn-green:hover {
            background-color: #1a7e52;
        }
        .btn-pdf {
            background-color: #b30000;
        }
        .btn-pdf:hover {
            background-color: #800000;
        }
        .btn-backup {
            background-color: #337ab7;
        }
        .btn-backup:hover {
            background-color: #286090;
        }
        .button-group-responsive {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        #results {
            margin-top: 20px;
            padding: 12px;
            background-color: #e9ecef;
            border-radius: 8px;
        }
        #results h3 {
            margin-top: 0;
            color: #00a2e3;
            font-size: 1.1em;
        }
        #results p {
            margin: 4px 0;
            font-size: 16px;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: #fff;
            font-size: 12px;
        }
        th, td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            white-space: nowrap;
        }
        th:last-child {
            text-align: center;
        }
        td:first-child {
            white-space: nowrap;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        #register-table tbody tr {
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInRow 0.5s ease-out forwards;
        }
        @keyframes fadeInRow {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .action-buttons-cell {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }
        #notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            opacity: 0;
            transform: translateY(100px);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        #notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        #notification.success {
            background-color: #28a745;
        }
        #notification.error {
            background-color: #dc3545;
        }
        .export-options-container {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: flex-start;
        }
        .export-options-container > select {
            width: 45%;
        }
        .export-options-container > .multiselect-dropdown {
            width: 45%;
        }
        select {
            padding: 0 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: #fff;
            height: 40px;
        }
        .multiselect-dropdown {
            position: relative;
            cursor: pointer;
            user-select: none;
        }
        .multiselect-selected {
            width: 100%;
            padding: 0 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #fff;
            height: 40px;
            font-size: 14px;
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
            gap: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            line-height: 40px;
            transition: box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .multiselect-selected:after {
            content: '▼';
            font-size: 12px;
            margin-left: auto;
            flex-shrink: 0;
        }
        .multiselect-options {
            position: absolute;
            width: 100%;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #fff;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
            box-sizing: border-box;
        }
        .multiselect-options.visible {
            display: block;
        }
        .multiselect-option {
            padding: 10px;
            display: flex;
            align-items: center;
        }
        .multiselect-option input[type="checkbox"] {
            margin-right: 10px;
            -webkit-appearance: checkbox;
        }
        .multiselect-option:hover {
            background-color: #f0f0f5;
        }
        .multiselect-dropdown.disabled {
            opacity: 0.6;
            pointer-events: none;
        }
        @media (min-width: 600px) {
            .multiselect-selected,
            .export-options-container > select {
                font-size: 16px;
                height: 48px;
                line-height: 48px;
            }
            .multiselect-option {
                font-size: 16px;
            }
        }
        .chart-container {
            margin: 20px 0;
            text-align: center;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="logo-text">TECNOSISTEM</div>
    <div class="form-group">
        <label for="date">Seleziona Giorno:</label>
        <input type="date" id="date">
    </div>

    <div class="form-group">
        <label for="workModeSelect">Modalità di lavoro:</label>
        <select id="workModeSelect">
            <option value="">Seleziona...</option>
            <option value="In Sede">In sede</option>
            <option value="Rientro">Trasferta (Rientro)</option>
            <option value="Pernottamento">Trasferta (Pernottamento)</option>
            <option value="Estero">Trasferta (Estero)</option>
        </select>
    </div>

    <div class="form-group">
        <label for="absenceType">Tipo di Assenza:</label>
        <select id="absenceType">
            <option value="">Nessuna assenza</option>
            <option value="Ferie">Ferie</option>
            <option value="Permesso">Permesso</option>
            <option value="Malattia">Malattia</option>
        </select>
    </div>

    <div id="work-fields">
        <div class="form-group">
            <label>Orario Inizio:</label>
            <div class="time-dropdown-container">
                <div id="startTimeDisplay" class="time-display" data-value="">Seleziona orario</div>
                <div id="startTimeOptions" class="time-options"></div>
            </div>
        </div>
        <div class="form-group">
            <label>Orario Fine:</label>
            <div class="time-dropdown-container">
                <div id="endTimeDisplay" class="time-display" data-value="">Seleziona orario</div>
                <div id="endTimeOptions" class="time-options"></div>
            </div>
        </div>
        <div class="checkbox-group">
            <input type="checkbox" id="lunchBreak">
            <label for="lunchBreak">Pausa pranzo (1 ora)</label>
        </div>
    </div>

    <div class="form-group">
        <label for="location">Luogo Intervento:</label>
        <input type="text" id="location" list="location-suggestions">
        <datalist id="location-suggestions"></datalist>
    </div>
    <div class="form-group">
        <label for="notes">Note:</label>
        <textarea id="notes"></textarea>
    </div>
    
    <div id="results">
        <h3>Riepilogo giornaliero</h3>
        <p id="totalHoursContainer"><strong>Ore totali:</strong> <span id="totalHours">0</span></p>
        <p id="overtimeHoursContainer"><strong>Ore straordinarie:</strong> <span id="overtimeHours">0</span></p>
        <p id="absenceHoursContainer" style="display: none;"><strong>Ore di assenza:</strong> <span id="absenceHours">0</span></p>
    </div>
    
    <button id="save-btn" class="btn btn-save-anim">
        <span class="btn-text">💾 Salva</span>
        <span class="btn-icon">✅</span>
    </button>
    
    <hr>
    
    <h2>Riepilogo Mensile</h2>
    <div class="chart-container">
        <canvas id="monthlyChart"></canvas>
    </div>
    
    <div class="table-container">
        <table id="monthly-summary-table">
            <thead>
                <tr>
                    <th>Mese</th>
                    <th>Ore Tot.</th>
                    <th>Ore Str.</th>
                    <th>Trasferta</th>
                    <th>Sede</th>
                    <th>Assenze</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    
    <hr>
    
    <h2 class="collapsible-header" id="toggle-settings">⚙️ Impostazioni Avanzate <span class="arrow">▼</span></h2>
    <div class="collapsible-content" id="settings-content">
        <p>Modifica i valori usati per i calcoli economici. I cambiamenti verranno salvati.</p>
        <div class="form-group">
            <label for="grossBaseSalaryInput">Paga Base Mensile Lorda (€):</label>
            <input type="number" id="grossBaseSalaryInput" step="0.01" min="0">
        </div>
        <div class="form-group">
            <label for="overtimeRateInput">Paga Oraria Straordinario 25% (€):</label>
            <input type="number" id="overtimeRateInput" step="0.01" min="0">
        </div>
        <div class="form-group">
            <label for="overtimeRate50Input">Paga Oraria Straordinario 50% (€):</label>
            <input type="number" id="overtimeRate50Input" step="0.01" min="0">
        </div>
        <div class="form-group">
            <label for="tripAllowanceReturnInput">Diaria Trasferta (Rientro) (€):</label>
            <input type="number" id="tripAllowanceReturnInput" step="0.01" min="0">
        </div>
        <div class="form-group">
            <label for="tripAllowanceOvernightInput">Diaria Trasferta (Pernottamento) (€):</label>
            <input type="number" id="tripAllowanceOvernightInput" step="0.01" min="0">
        </div>
        <div class="form-group">
            <label for="tripAllowanceAbroadInput">Diaria Trasferta (Estero) (€):</label>
            <input type="number" id="tripAllowanceAbroadInput" step="0.01" min="0">
        </div>
        <div class="form-group">
            <label for="taxRateInput">Aliquota Fiscale (%):</label>
            <input type="number" id="taxRateInput" step="0.01" min="0" max="100">
        </div>
    </div>
    
    <hr>
    
    <h2 class="collapsible-header" id="toggle-gross-net">💰 Riepilogo Lordo/Netto <span class="arrow">▼</span></h2>
    <div class="collapsible-content" id="gross-net-content">
        <div id="gross-net-summary">
            <h3>Riepilogo Lordo/Netto</h3>
            <p><strong>Stipendio Base Lordo:</strong> <span id="grossBaseSalary">0.00 €</span></p>
            <p><strong>Diaria Trasferte:</strong> <span id="grossTripAllowance">0.00 €</span></p>
            <p><strong>Straordinari 25%:</strong> <span id="grossOvertime25">0.00 €</span></p>
            <p><strong>Straordinari 50%:</strong> <span id="grossOvertime50">0.00 €</span></p>
            <p><strong>Totale Lordo:</strong> <span id="totalGross">0.00 €</span></p>
            <p><strong>Totale Netto (stima):</strong> <span id="totalNet">0.00 €</span></p>
        </div>
    </div>
    
    <hr>
    
    <h2 class="collapsible-header" id="toggle-register">📋 Registro Completo <span class="arrow">▼</span></h2>
    <div class="collapsible-content" id="register-content">
        <div class="form-group">
            <label for="search">Cerca:</label>
            <input type="text" id="search" placeholder="Cerca per data, luogo, note...">
        </div>
        <div class="export-options-container">
            <select id="filterYearSelect">
                <option value="">Tutti gli Anni</option>
            </select>
            <div id="filterMonthContainer" class="multiselect-dropdown">
                <div class="multiselect-selected">Tutti i Mesi</div>
                <div id="filterMonthOptions" class="multiselect-options"></div>
            </div>
        </div>
        <div class="table-container">
            <table id="register-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Inizio</th>
                        <th>Fine</th>
                        <th>Assenza</th>
                        <th>Ore Tot.</th>
                        <th>Ore Str.</th>
                        <th>Modalità</th>
                        <th>Luogo</th>
                        <th>Note</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
    
    <hr>
    
    <h2 class="collapsible-header" id="toggle-export">📤 Esporta Dati <span class="arrow">▼</span></h2>
    <div class="collapsible-content" id="export-content">
        <p>Esporta il registro in formato CSV o PDF. Seleziona anno e mesi specifici o esporta tutto.</p>
        <div class="export-options-container">
            <select id="exportYearSelect">
                <option value="">Seleziona Anno</option>
            </select>
            <div id="multiselect-month-container" class="multiselect-dropdown disabled">
                <div class="multiselect-selected">Seleziona Mesi</div>
                <div id="multiselect-month-options" class="multiselect-options"></div>
            </div>
        </div>
        <div class="button-group-responsive">
            <button id="export-selected-btn" class="btn btn-green">📄 Esporta CSV Selezionato</button>
            <button id="export-selected-pdf-btn" class="btn btn-pdf">📄 Esporta PDF Selezionato</button>
            <button id="export-all-btn" class="btn btn-green">📄 Esporta Tutto CSV</button>
            <button id="export-pdf-btn" class="btn btn-pdf">📄 Esporta Tutto PDF</button>
        </div>
        <button id="export-data-btn" class="btn btn-backup">💾 Backup Dati (JSON)</button>
        <button id="import-data-btn" class="btn btn-backup">📥 Importa Backup</button>
        <input type="file" id="import-file" accept=".json" style="display: none;">
    </div>
    
    <div id="notification"></div>
</div>

<script type="module">
    // Firebase imports and initialization
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB8gbRE-a8U7ed9IuHIXgxWFj-PEe6_Vg4",
        authDomain: "orari-ts.firebaseapp.com",
        databaseURL: "https://orari-ts-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "orari-ts",
        storageBucket: "orari-ts.firebasestorage.app",
        messagingSenderId: "375795078333",
        appId: "1:375795078333:web:803f281017af9144e813d4",
        measurementId: "G-J2H4KV35T1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Original script with modifications for Firebase
    const STORAGE_KEY = 'registroLavoro';
    const SETTINGS_KEY = 'registroSettings';
    let registerData = {};
    let currentUser = null;

    const dateInput = document.getElementById('date');
    const workModeSelect = document.getElementById('workModeSelect');
    const absenceTypeSelect = document.getElementById('absenceType');
    const startTimeDisplay = document.getElementById('startTimeDisplay');
    const startTimeOptions = document.getElementById('startTimeOptions');
    const endTimeDisplay = document.getElementById('endTimeDisplay');
    const endTimeOptions = document.getElementById('endTimeOptions');
    const lunchBreakCheckbox = document.getElementById('lunchBreak');
    const locationInput = document.getElementById('location');
    const notesInput = document.getElementById('notes');
    const totalHoursSpan = document.getElementById('totalHours');
    const overtimeHoursSpan = document.getElementById('overtimeHours');
    const absenceHoursSpan = document.getElementById('absenceHours');
    const absenceHoursContainer = document.getElementById('absenceHoursContainer');
    const saveButton = document.getElementById('save-btn');
    const notification = document.getElementById('notification');
    const monthlyChartCanvas = document.getElementById('monthlyChart');
    const grossBaseSalaryInput = document.getElementById('grossBaseSalaryInput');
    const overtimeRateInput = document.getElementById('overtimeRateInput');
    const overtimeRate50Input = document.getElementById('overtimeRate50Input');
    const tripAllowanceReturnInput = document.getElementById('tripAllowanceReturnInput');
    const tripAllowanceOvernightInput = document.getElementById('tripAllowanceOvernightInput');
    const tripAllowanceAbroadInput = document.getElementById('tripAllowanceAbroadInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const grossBaseSalarySpan = document.getElementById('grossBaseSalary');
    const grossTripAllowanceSpan = document.getElementById('grossTripAllowance');
    const grossOvertime25Span = document.getElementById('grossOvertime25');
    const grossOvertime50Span = document.getElementById('grossOvertime50');
    const totalGrossSpan = document.getElementById('totalGross');
    const totalNetSpan = document.getElementById('totalNet');
    const searchInput = document.getElementById('search');
    const filterYearSelect = document.getElementById('filterYearSelect');
    const filterMonthContainer = document.getElementById('filterMonthContainer');
    const filterMonthOptions = document.getElementById('filterMonthOptions');
    const registerBody = document.querySelector('#register-table tbody');
    const monthlySummaryBody = document.querySelector('#monthly-summary-table tbody');
    const toggleRegisterHeader = document.getElementById('toggle-register');
    const toggleSettingsHeader = document.getElementById('toggle-settings');
    const toggleGrossNetHeader = document.getElementById('toggle-gross-net');
    const toggleExportHeader = document.getElementById('toggle-export');
    const exportYearSelect = document.getElementById('exportYearSelect');
    const multiselectMonthContainer = document.getElementById('multiselect-month-container');
    const multiselectMonthOptions = document.getElementById('multiselect-month-options');
    const exportSelectedButton = document.getElementById('export-selected-btn');
    const exportAllButton = document.getElementById('export-all-btn');
    const exportPdfButton = document.getElementById('export-pdf-btn');
    const exportSelectedPdfButton = document.getElementById('export-selected-pdf-btn');
    const exportDataBtn = document.getElementById('export-data-btn');
    const importDataBtn = document.getElementById('import-data-btn');
    const importFile = document.getElementById('import-file');
    const locationSuggestions = document.getElementById('location-suggestions');

    let grossBaseSalary = 0;
    let overtimeRate = 0;
    let overtimeRate50 = 0;
    let tripAllowanceReturn = 0;
    let tripAllowanceOvernight = 0;
    let tripAllowanceAbroad = 0;
    let taxRate = 0;

    let monthlyChart = null;

    function generateTimeOptions() {
        const times = [];
        for (let hour = 0; hour < 24; hour++) {
            for (let minute = 0; minute < 60; minute += 15) {
                const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                times.push(timeStr);
            }
        }
        const optionsHtml = times.map(time => `<div class="time-option" data-value="${time}">${time}</div>`).join('');
        startTimeOptions.innerHTML = optionsHtml;
        endTimeOptions.innerHTML = optionsHtml;
    }

    function setTimeDropdown(display, options, value) {
        display.textContent = value;
        display.setAttribute('data-value', value);
        options.querySelectorAll('.time-option').forEach(option => {
            option.classList.toggle('selected', option.getAttribute('data-value') === value);
        });
    }

    function calculateHours() {
        const date = dateInput.value;
        const startTime = startTimeDisplay.getAttribute('data-value');
        const endTime = endTimeDisplay.getAttribute('data-value');
        const lunchBreak = lunchBreakCheckbox.checked;
        const absenceType = absenceTypeSelect.value;

        if (!date || (!absenceType && (!startTime || !endTime))) {
            totalHoursSpan.textContent = '0';
            overtimeHoursSpan.textContent = '0';
            absenceHoursContainer.style.display = 'none';
            return;
        }

        if (absenceType) {
            absenceHoursContainer.style.display = 'block';
            absenceHoursSpan.textContent = '8';
            totalHoursSpan.textContent = '0';
            overtimeHoursSpan.textContent = '0';
            return;
        } else {
            absenceHoursContainer.style.display = 'none';
        }

        const [startHour, startMinute] = startTime.split(':').map(Number);
        const [endHour, endMinute] = endTime.split(':').map(Number);

        const startDate = new Date(2000, 0, 1, startHour, startMinute);
        const endDate = new Date(2000, 0, 1, endHour, endMinute);

        if (endDate <= startDate) {
            endDate.setDate(endDate.getDate() + 1);
        }

        let totalMinutes = (endDate - startDate) / (1000 * 60);
        if (lunchBreak) totalMinutes -= 60;

        const totalHours = totalMinutes / 60;
        let overtimeHours = Math.max(totalHours - 8, 0);

        totalHoursSpan.textContent = totalHours.toFixed(2);
        overtimeHoursSpan.textContent = overtimeHours.toFixed(2);
    }

    function showNotification(message, type) {
        notification.textContent = message;
        notification.classList.remove('success', 'error');
        notification.classList.add(type, 'show');
        setTimeout(() => notification.classList.remove('show'), 3000);
    }

    function saveEntry() {
        const date = dateInput.value;
        if (!date) {
            showNotification('Seleziona una data.', 'error');
            return;
        }

        const entry = {
            date,
            workMode: workModeSelect.value,
            absenceType: absenceTypeSelect.value,
            startTime: startTimeDisplay.getAttribute('data-value'),
            endTime: endTimeDisplay.getAttribute('data-value'),
            lunchBreak: lunchBreakCheckbox.checked,
            location: locationInput.value,
            notes: notesInput.value,
            totalHours: parseFloat(totalHoursSpan.textContent),
            overtimeHours: parseFloat(overtimeHoursSpan.textContent)
        };

        registerData[date] = entry;
        saveDataToFirebase();

        showNotification('Dati salvati!', 'success');
        saveButton.classList.add('saved');
        setTimeout(() => saveButton.classList.remove('saved'), 1000);

        renderAllData();
        clearForm();
    }

    function clearForm() {
        workModeSelect.value = '';
        absenceTypeSelect.value = '';
        setTimeDropdown(startTimeDisplay, startTimeOptions, '');
        setTimeDropdown(endTimeDisplay, endTimeOptions, '');
        lunchBreakCheckbox.checked = false;
        locationInput.value = '';
        notesInput.value = '';
        calculateHours();
    }

    function editEntry(date) {
        const entry = registerData[date];
        if (!entry) return;

        dateInput.value = entry.date;
        workModeSelect.value = entry.workMode || '';
        absenceTypeSelect.value = entry.absenceType || '';
        setTimeDropdown(startTimeDisplay, startTimeOptions, entry.startTime || '');
        setTimeDropdown(endTimeDisplay, endTimeOptions, entry.endTime || '');
        lunchBreakCheckbox.checked = entry.lunchBreak || false;
        locationInput.value = entry.location || '';
        notesInput.value = entry.notes || '';
        calculateHours();

        deleteEntry(date, false);
    }

    function deleteEntry(date, confirm = true) {
        if (confirm && !window.confirm('Sicuro di voler eliminare questa voce?')) return;

        delete registerData[date];
        saveDataToFirebase();
        renderAllData();
        if (confirm) showNotification('Voce eliminata.', 'success');
    }

    function renderRegister() {
        registerBody.innerHTML = '';
        const searchTerm = searchInput.value.toLowerCase();
        const selectedYear = filterYearSelect.value;
        const selectedMonths = Array.from(filterMonthOptions.querySelectorAll('input:checked')).map(cb => cb.value);

        const filteredData = Object.entries(registerData)
            .filter(([date, entry]) => {
                const entryDate = new Date(date);
                const yearMatch = !selectedYear || date.startsWith(selectedYear);
                const monthMatch = selectedMonths.length === 0 || selectedMonths.includes(date.substring(5, 7));
                const searchMatch = !searchTerm ||
                    date.toLowerCase().includes(searchTerm) ||
                    (entry.location && entry.location.toLowerCase().includes(searchTerm)) ||
                    (entry.notes && entry.notes.toLowerCase().includes(searchTerm)) ||
                    (entry.workMode && entry.workMode.toLowerCase().includes(searchTerm)) ||
                    (entry.absenceType && entry.absenceType.toLowerCase().includes(searchTerm));
                return yearMatch && monthMatch && searchMatch;
            })
            .sort((a, b) => new Date(b[0]) - new Date(a[0]));

        filteredData.forEach(([date, entry], index) => {
            const row = document.createElement('tr');
            row.style.animationDelay = `${index * 0.05}s`;
            const totalOvertime = (entry.overtimeHours || 0) + (entry.overtimeHours50 || 0);
            row.innerHTML = `
                <td>${formatDate(date)}</td>
                <td>${entry.startTime || '-'}</td>
                <td>${entry.endTime || '-'}</td>
                <td>${entry.absenceType || '-'}</td>
                <td>${entry.totalHours.toFixed(2)}</td>
                <td>${totalOvertime.toFixed(2)}</td>
                <td>${entry.workMode || '-'}</td>
                <td>${entry.location || ''}</td>
                <td>${entry.notes || ''}</td>
                <td class="action-buttons-cell">
                    <button class="btn btn-small btn-edit" data-date="${date}">✏️</button>
                    <button class="btn btn-small btn-delete" data-date="${date}">🗑️</button>
                </td>
            `;
            registerBody.appendChild(row);
        });
    }

    function formatDate(dateStr) {
        const [year, month, day] = dateStr.split('-');
        return `${day}/${month}/${year}`;
    }

    function renderMonthlySummary() {
        const monthlySummary = {};
        Object.values(registerData).forEach(entry => {
            const monthYear = entry.date.substring(0, 7);
            if (!monthlySummary[monthYear]) {
                monthlySummary[monthYear] = { totalHours: 0, overtimeHours: 0, tripCount: 0, onSiteCount: 0, absenceCount: 0 };
            }
            monthlySummary[monthYear].totalHours += entry.totalHours;
            monthlySummary[monthYear].overtimeHours += (entry.overtimeHours || 0) + (entry.overtimeHours50 || 0);
            if (entry.workMode && entry.workMode !== 'In Sede') monthlySummary[monthYear].tripCount++;
            if (entry.workMode === 'In Sede') monthlySummary[monthYear].onSiteCount++;
            if (entry.absenceType) monthlySummary[monthYear].absenceCount++;
        });

        monthlySummaryBody.innerHTML = '';
        Object.keys(monthlySummary).sort().reverse().forEach(monthYear => {
            const summary = monthlySummary[monthYear];
            const [year, month] = monthYear.split('-');
            const monthName = new Date(year, month - 1, 1).toLocaleString('it-IT', { month: 'long' });
            const row = `
                <tr>
                    <td>${monthName.charAt(0).toUpperCase() + monthName.slice(1)} ${year}</td>
                    <td>${summary.totalHours.toFixed(2)}</td>
                    <td>${summary.overtimeHours.toFixed(2)}</td>
                    <td>${summary.tripCount}</td>
                    <td>${summary.onSiteCount}</td>
                    <td>${summary.absenceCount}</td>
                </tr>
            `;
            monthlySummaryBody.innerHTML += row;
        });
    }

    function renderChart() {
        const monthlyData = {};
        Object.values(registerData).forEach(entry => {
            const monthYear = entry.date.substring(0, 7);
            if (!monthlyData[monthYear]) {
                monthlyData[monthYear] = { totalHours: 0, overtimeHours: 0 };
            }
            monthlyData[monthYear].totalHours += entry.totalHours;
            monthlyData[monthYear].overtimeHours += (entry.overtimeHours || 0) + (entry.overtimeHours50 || 0);
        });

        const labels = Object.keys(monthlyData).sort().map(monthYear => {
            const [year, month] = monthYear.split('-');
            return new Date(year, month - 1, 1).toLocaleString('it-IT', { month: 'short', year: 'numeric' });
        });
        const totalHoursData = labels.map(label => {
            const monthYear = `${label.split(' ')[1]}-${label.split(' ')[0].toLowerCase() === 'gen' ? '01' : '...'}`; // Simplified
            return monthlyData[monthYear]?.totalHours || 0;
        });
        const overtimeData = labels.map(label => {
            const monthYear = `${label.split(' ')[1]}-${label.split(' ')[0].toLowerCase() === 'gen' ? '01' : '...'}`; // Simplified
            return monthlyData[monthYear]?.overtimeHours || 0;
        });

        if (monthlyChart) monthlyChart.destroy();
        monthlyChart = new Chart(monthlyChartCanvas, {
            type: 'bar',
            data: {
                labels,
                datasets: [
                    { label: 'Ore Totali', data: totalHoursData, backgroundColor: '#00a2e3' },
                    { label: 'Ore Straordinarie', data: overtimeData, backgroundColor: '#ff6384' }
                ]
            },
            options: {
                scales: { y: { beginAtZero: true } },
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    function calculateGrossNetSummary() {
        let totalGross = grossBaseSalary;
        let tripAllowance = 0;
        let overtime25 = 0;
        let overtime50 = 0;

        Object.values(registerData).forEach(entry => {
            if (entry.workMode === 'Rientro') tripAllowance += tripAllowanceReturn;
            else if (entry.workMode === 'Pernottamento') tripAllowance += tripAllowanceOvernight;
            else if (entry.workMode === 'Estero') tripAllowance += tripAllowanceAbroad;

            overtime25 += (entry.overtimeHours || 0) * overtimeRate;
            overtime50 += (entry.overtimeHours50 || 0) * overtimeRate50;
        });

        totalGross += tripAllowance + overtime25 + overtime50;
        const totalNet = totalGross * (1 - taxRate);

        grossBaseSalarySpan.textContent = grossBaseSalary.toFixed(2) + ' €';
        grossTripAllowanceSpan.textContent = tripAllowance.toFixed(2) + ' €';
        grossOvertime25Span.textContent = overtime25.toFixed(2) + ' €';
        grossOvertime50Span.textContent = overtime50.toFixed(2) + ' €';
        totalGrossSpan.textContent = totalGross.toFixed(2) + ' €';
        totalNetSpan.textContent = totalNet.toFixed(2) + ' €';
    }

    function updateLocationSuggestions() {
        const locations = [...new Set(Object.values(registerData).map(entry => entry.location).filter(Boolean))];
        locationSuggestions.innerHTML = locations.map(loc => `<option value="${loc}">`).join('');
    }

    function renderAllData() {
        renderRegister();
        renderMonthlySummary();
        renderChart();
        calculateGrossNetSummary();
        updateLocationSuggestions();
        updateFilterExportOptions();
    }

    function filterRegister() {
        renderRegister();
    }

    function updateFilterExportOptions() {
        const years = [...new Set(Object.keys(registerData).map(date => date.substring(0, 4)))].sort().reverse();
        filterYearSelect.innerHTML = `<option value="">Tutti gli Anni</option>` + years.map(year => `<option value="${year}">${year}</option>`).join('');
        exportYearSelect.innerHTML = `<option value="">Seleziona Anno</option>` + years.map(year => `<option value="${year}">${year}</option>`).join('');

        const months = ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"];
        const monthNames = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
        
        filterMonthOptions.innerHTML = months.map((month, index) =>
            `<div class="multiselect-option">
                <input type="checkbox" id="filter-month-${month}" value="${month}">
                <label for="filter-month-${month}">${monthNames[index]}</label>
            </div>`).join('');

        multiselectMonthOptions.innerHTML = months.map((month, index) =>
            `<div class="multiselect-option">
                <input type="checkbox" id="export-month-${month}" value="${month}">
                <label for="export-month-${month}">${monthNames[index]}</label>
            </div>`).join('');
    }

    function updateExportOptions() {
        const selectedYear = exportYearSelect.value;
        const multiselect = document.getElementById('multiselect-month-container');
        if (selectedYear) {
            multiselect.classList.remove('disabled');
        } else {
            multiselect.classList.add('disabled');
        }
    }
    
    function generateCsvData(data) {
        const headers = ["Data", "Orario Inizio", "Orario Fine", "Assenza", "Ore Totali", "Ore Straordinarie", "Modalità", "Luogo Intervento", "Note"];
        let csv = headers.join(";") + "\n";
        data.forEach(entry => {
            const totalOvertime = (entry.overtimeHours || 0) + (entry.overtimeHours50 || 0);
            const row = [
                `"${formatDate(entry.date)}"`,
                `"${entry.startTime || '-'}"`,
                `"${entry.endTime || '-'}"`,
                `"${entry.absenceType || '-'}"`,
                `"${entry.totalHours.toFixed(2)}"`,
                `"${totalOvertime.toFixed(2)}"`,
                `"${entry.workMode || '-'}"`,
                `"${entry.location || ''}"`,
                `"${entry.notes || ''}"`
            ];
            csv += row.join(";") + "\n";
        });
        return csv;
    }
    
    function exportCsv(data, filename) {
        const csv = generateCsvData(data);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        showNotification('Esportazione CSV completata!', 'success');
    }
    
    function generatePdf(data) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'pt', 'a4');
        const sortedData = data.sort((a, b) => new Date(a.date) - new Date(b.date));

        // 1. Logica per creare il riepilogo mensile per il PDF
        const monthlySummary = {};
        sortedData.forEach(entry => {
            const monthYear = entry.date.substring(0, 7);
            if (!monthlySummary[monthYear]) {
                monthlySummary[monthYear] = { totalHours: 0, overtimeHours: 0, tripCount: 0, onSiteCount: 0, absenceCount: 0 };
            }
            monthlySummary[monthYear].totalHours += entry.totalHours;
            monthlySummary[monthYear].overtimeHours += (entry.overtimeHours || 0) + (entry.overtimeHours50 || 0);
            if (entry.workMode && entry.workMode !== 'In Sede') monthlySummary[monthYear].tripCount++;
            if (entry.workMode === 'In Sede') monthlySummary[monthYear].onSiteCount++;
            if (entry.absenceType) monthlySummary[monthYear].absenceCount++;
        });

        const summaryData = Object.keys(monthlySummary).sort().map(monthYear => {
            const summary = monthlySummary[monthYear];
            const [year, month] = monthYear.split('-');
            const monthName = new Date(year, month - 1, 1).toLocaleString('it-IT', { month: 'long', year: 'numeric' });
            return [
                monthName.charAt(0).toUpperCase() + monthName.slice(1),
                summary.totalHours.toFixed(2),
                summary.overtimeHours.toFixed(2),
                summary.tripCount,
                summary.onSiteCount,
                summary.absenceCount
            ];
        });

        let lastY = 40;

        // 2. Disegna la tabella di riepilogo se ci sono dati
        if (summaryData.length > 0) {
            doc.text("Riepilogo Mensile", 40, lastY);
            lastY += 10;
            doc.autoTable({
                startY: lastY,
                head: [["Mese", "Ore Tot.", "Ore Str.", "Trasferta", "Sede", "Assenze"]],
                body: summaryData,
                styles: { fontSize: 8, cellPadding: 4 },
                headStyles: { fillColor: '#00a2e3' }
            });
            lastY = doc.autoTable.previous.finalY;
        }

        // 3. Prepara i dati per la tabella del registro completo
        const tableData = sortedData.map(entry => {
            const totalOvertime = (entry.overtimeHours || 0) + (entry.overtimeHours50 || 0);
            return [
                formatDate(entry.date),
                entry.startTime || '-',
                entry.endTime || '-',
                entry.absenceType || '-',
                entry.totalHours.toFixed(2),
                totalOvertime.toFixed(2),
                entry.workMode || '-',
                entry.location || '',
                entry.notes || ''
            ];
        });
        
        const head = [["Data", "Inizio", "Fine", "Assenza", "Ore Tot.", "Ore Str.", "Modalità", "Luogo", "Note"]];

        // 4. Disegna la tabella del registro completo
        lastY += 20;
        doc.text("Registro Completo", 40, lastY);
        lastY += 10;
        doc.autoTable({
            startY: lastY,
            head: head,
            body: tableData,
            styles: { fontSize: 8, cellPadding: 4 },
            headStyles: { fillColor: '#00a2e3' }
        });
        
        doc.save('Registro_Lavoro.pdf');
        showNotification('Esportazione PDF avviata!', 'success');
    }
    
    function saveSettings() {
        const settings = {
            grossBaseSalary: parseFloat(grossBaseSalaryInput.value) || 0,
            overtimeRate: parseFloat(overtimeRateInput.value) || 0,
            overtimeRate50: parseFloat(overtimeRate50Input.value) || 0,
            tripAllowanceReturn: parseFloat(tripAllowanceReturnInput.value) || 0,
            tripAllowanceOvernight: parseFloat(tripAllowanceOvernightInput.value) || 0,
            tripAllowanceAbroad: parseFloat(tripAllowanceAbroadInput.value) || 0,
            taxRate: parseFloat(taxRateInput.value) / 100 || 0
        };
        grossBaseSalary = settings.grossBaseSalary;
        overtimeRate = settings.overtimeRate;
        overtimeRate50 = settings.overtimeRate50;
        tripAllowanceReturn = settings.tripAllowanceReturn;
        tripAllowanceOvernight = settings.tripAllowanceOvernight;
        tripAllowanceAbroad = settings.tripAllowanceAbroad;
        taxRate = settings.taxRate;
        
        saveSettingsToFirebase(settings);
        calculateGrossNetSummary();
        showNotification('Impostazioni salvate!', 'success');
    }
    
    function loadSettings(settings) {
        grossBaseSalaryInput.value = settings.grossBaseSalary || grossBaseSalary;
        overtimeRateInput.value = settings.overtimeRate || overtimeRate;
        overtimeRate50Input.value = settings.overtimeRate50 || overtimeRate50;
        tripAllowanceReturnInput.value = settings.tripAllowanceReturn || tripAllowanceReturn;
        tripAllowanceOvernightInput.value = settings.tripAllowanceOvernight || tripAllowanceOvernight;
        tripAllowanceAbroadInput.value = settings.tripAllowanceAbroad || tripAllowanceAbroad;
        taxRateInput.value = (settings.taxRate * 100) || (taxRate * 100);

        grossBaseSalary = parseFloat(grossBaseSalaryInput.value);
        overtimeRate = parseFloat(overtimeRateInput.value);
        overtimeRate50 = parseFloat(overtimeRate50Input.value);
        tripAllowanceReturn = parseFloat(tripAllowanceReturnInput.value);
        tripAllowanceOvernight = parseFloat(tripAllowanceOvernightInput.value);
        tripAllowanceAbroad = parseFloat(tripAllowanceAbroadInput.value);
        taxRate = parseFloat(taxRateInput.value) / 100;
    }

    // Firebase functions
    function saveDataToFirebase() {
        if (currentUser) {
            const userRef = ref(db, 'users/' + currentUser.uid + '/registerData');
            set(userRef, registerData);
        }
    }

    function saveSettingsToFirebase(settings) {
        if (currentUser) {
            const settingsRef = ref(db, 'users/' + currentUser.uid + '/settings');
            set(settingsRef, settings);
        }
    }

    // Event Listeners
    dateInput.addEventListener('change', calculateHours);
    
    workModeSelect.addEventListener('change', () => {
        const mode = workModeSelect.value;
        if (mode === 'In Sede') {
            locationInput.value = 'Tecnosistem';
            // Non sovrascrive gli orari se sono già stati impostati manualmente
            if (!startTimeDisplay.getAttribute('data-value')) {
                setTimeDropdown(startTimeDisplay, startTimeOptions, '08:00');
            }
            if (!endTimeDisplay.getAttribute('data-value')) {
                setTimeDropdown(endTimeDisplay, endTimeOptions, '17:00');
            }
            lunchBreakCheckbox.checked = true;
        } else if (mode === 'Rientro' || mode === 'Pernottamento' || mode === 'Estero') {
            // Pulisce il luogo solo se era quello di default
            if (locationInput.value === 'Tecnosistem') {
                locationInput.value = '';
            }
        }
        calculateHours();
    });

    absenceTypeSelect.addEventListener('change', () => {
        const absence = absenceTypeSelect.value;
        if (absence) {
            workModeSelect.value = '';
            locationInput.value = 'Assenza';
            setTimeDropdown(startTimeDisplay, startTimeOptions, '08:00');
            setTimeDropdown(endTimeDisplay, endTimeOptions, '17:00');
            lunchBreakCheckbox.checked = true;
        }
        calculateHours();
    });
    
    [startTimeDisplay, endTimeDisplay].forEach(display => {
        display.addEventListener('click', (e) => {
            e.stopPropagation();
            const options = display === startTimeDisplay ? startTimeOptions : endTimeOptions;
            const otherOptions = display === startTimeDisplay ? endTimeOptions : startTimeOptions;
            options.classList.toggle('visible');
            otherOptions.classList.remove('visible');
            if (options.classList.contains('visible')) {
                const selected = options.querySelector('.selected');
                if (selected) {
                    selected.scrollIntoView({ block: 'center' });
                }
            }
        });
    });

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.time-dropdown-container')) {
            startTimeOptions.classList.remove('visible');
            endTimeOptions.classList.remove('visible');
        }
    });

    [startTimeOptions, endTimeOptions].forEach(options => {
        options.addEventListener('click', (e) => {
            const display = options === startTimeOptions ? startTimeDisplay : endTimeDisplay;
            if (e.target.classList.contains('time-option')) {
                const selectedOption = e.target;
                const value = selectedOption.getAttribute('data-value');
                display.textContent = value;
                display.setAttribute('data-value', value);
                options.classList.remove('visible');
                options.querySelectorAll('.time-option').forEach(option => option.classList.remove('selected'));
                selectedOption.classList.add('selected');
                calculateHours();
            }
        });
    });
    
    lunchBreakCheckbox.addEventListener('change', calculateHours);
    saveButton.addEventListener('click', saveEntry);

    registerBody.addEventListener('click', (e) => {
        const date = e.target.getAttribute('data-date');
        if (e.target.classList.contains('btn-delete')) {
            deleteEntry(date);
        } else if (e.target.classList.contains('btn-edit')) {
            editEntry(date);
        }
    });
    
    [toggleRegisterHeader, toggleSettingsHeader, toggleGrossNetHeader, toggleExportHeader].forEach(header => {
        header.addEventListener('click', () => {
            const content = document.getElementById(header.id.replace('toggle-', '') + '-content');
            header.classList.toggle('open');
            content.classList.toggle('open');
        });
    });

    searchInput.addEventListener('input', filterRegister);
    filterYearSelect.addEventListener('change', filterRegister);
    filterMonthOptions.addEventListener('change', filterRegister);
    
    multiselectMonthContainer.addEventListener('click', (e) => {
        e.stopPropagation();
        if (!exportYearSelect.value) return;
        multiselectMonthOptions.classList.toggle('visible');
    });
    
    filterMonthContainer.addEventListener('click', (e) => {
        e.stopPropagation();
        filterMonthOptions.classList.toggle('visible');
    });

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.multiselect-dropdown')) {
            filterMonthOptions.classList.remove('visible');
            multiselectMonthOptions.classList.remove('visible');
        }
    });

    exportYearSelect.addEventListener('change', updateExportOptions);
    
    exportSelectedButton.addEventListener('click', () => {
        const year = exportYearSelect.value;
        const months = Array.from(multiselectMonthOptions.querySelectorAll('input:checked')).map(cb => cb.value);
        if (!year || months.length === 0) {
            showNotification('Seleziona un anno e almeno un mese per l\'esportazione.', 'error');
            return;
        }
        const filteredData = Object.values(registerData).filter(entry => entry.date.startsWith(year) && months.includes(entry.date.substring(5, 7)));
        if (filteredData.length > 0) {
            exportCsv(filteredData, `Registro_${year}_${months.join('-')}.csv`);
        } else {
            showNotification('Nessun dato trovato per il periodo selezionato.', 'error');
        }
    });

    exportAllButton.addEventListener('click', () => {
        const dataArray = Object.values(registerData);
        if (dataArray.length > 0) {
            exportCsv(dataArray, 'Registro_Completo.csv');
        } else {
            showNotification('Nessun dato da esportare.', 'error');
        }
    });
    
    exportPdfButton.addEventListener('click', () => {
        const dataArray = Object.values(registerData);
        if (dataArray.length > 0) {
            generatePdf(dataArray);
        } else {
            showNotification('Nessun dato da esportare.', 'error');
        }
    });

    exportSelectedPdfButton.addEventListener('click', () => {
        const year = exportYearSelect.value;
        const months = Array.from(multiselectMonthOptions.querySelectorAll('input:checked')).map(cb => cb.value);
        if (!year || months.length === 0) {
            showNotification('Seleziona un anno e almeno un mese per l\'esportazione.', 'error');
            return;
        }
        const filteredData = Object.values(registerData).filter(entry => entry.date.startsWith(year) && months.includes(entry.date.substring(5, 7)));
        if (filteredData.length > 0) {
            generatePdf(filteredData);
        } else {
            showNotification('Nessun dato trovato per il periodo selezionato.', 'error');
        }
    });

    exportDataBtn.addEventListener('click', () => {
        const dataStr = JSON.stringify(registerData);
        const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
        const link = document.createElement('a');
        link.setAttribute('href', dataUri);
        link.setAttribute('download', 'registro_lavoro_backup.json');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showNotification('Backup creato con successo!', 'success');
    });

    importDataBtn.addEventListener('click', () => {
        importFile.click();
    });

    importFile.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                if (typeof importedData === 'object' && importedData !== null) {
                    registerData = importedData;
                    saveDataToFirebase();
                    renderAllData();
                    showNotification('Dati importati con successo!', 'success');
                } else {
                    showNotification('Il file importato non è in un formato valido.', 'error');
                }
            } catch (error) {
                showNotification('Errore durante l\'importazione del file.', 'error');
                console.error(error);
            }
        };
        reader.readAsText(file);
    });

    [grossBaseSalaryInput, overtimeRateInput, overtimeRate50Input, tripAllowanceReturnInput, tripAllowanceOvernightInput, tripAllowanceAbroadInput, taxRateInput].forEach(input => {
        input.addEventListener('change', saveSettings);
    });

    // Inizializzazione
    function initialize() {
        generateTimeOptions();
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
        calculateHours();
    }

    // Firebase auth state listener
    onAuthStateChanged(auth, user => {
        currentUser = user;
        if (user) {
            const userDataRef = ref(db, 'users/' + user.uid + '/registerData');
            onValue(userDataRef, snapshot => {
                registerData = snapshot.val() || {};
                renderAllData();
            });

            const settingsRef = ref(db, 'users/' + user.uid + '/settings');
            onValue(settingsRef, snapshot => {
                const storedSettings = snapshot.val() || {};
                loadSettings(storedSettings);
                renderAllData();
            });
        } else {
            // User not logged in, use empty data or local fallback if needed
            registerData = {};
            renderAllData();
            showNotification('Non sei autenticato. I dati non saranno sincronizzati.', 'error');
        }
    });

    initialize();
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</body>
</html>
