<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Orario Lavoro</title>
    <link rel="apple-touch-icon" href="img/apple-touch-icon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-body: #f0f0f5;
            --bg-container: #fff;
            --text-color: #333;
            --accent-color: #00a2e3;
            --input-border: #ccc;
            --input-bg: #fff;
            --dropdown-bg: #fff;
            --dropdown-text: #333;
            --dropdown-hover: #f0f0f5;
            --table-even: #f2f2f2;
            --table-head: #f8f9fa;
            --results-bg: #e9ecef;
            --notification-success: #28a745;
            --notification-error: #dc3545;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --logo-gradient: linear-gradient(to right, #ef5350, #f48fb1, #7e57c2, #2196f3, #26c6da, #43a047, #eeff41, #f9a825, #ff5722);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-body: #121212;
                --bg-container: #1e1e1e;
                --text-color: #e0e0e0;
                --accent-color: #00a2e3;
                --input-border: #444;
                --input-bg: #333;
                --dropdown-bg: #333;
                --dropdown-text: #e0e0e0;
                --dropdown-hover: #444;
                --table-even: #2a2a2a;
                --table-head: #333;
                --results-bg: #2a2a2a;
                --notification-success: #28a745;
                --notification-error: #dc3545;
                --shadow-color: rgba(0, 0, 0, 0.5);
                --logo-gradient: linear-gradient(to right, #ef5350, #f48fb1, #7e57c2, #2196f3, #26c6da, #43a047, #eeff41, #f9a825, #ff5722);
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Segoe UI Emoji", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            margin: 0;
            padding: 10px;
            color: var(--text-color);
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
            background-color: var(--bg-container);
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        .logo-text {
            text-align: center;
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 15px;
            background: var(--logo-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        h1, h2 {
            text-align: center;
            color: var(--accent-color);
            margin-bottom: 15px;
        }
        h2 {
            margin-top: 30px;
        }
        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-bottom: 0;
            font-size: 1.2em;
        }
        .collapsible-header i:first-child {
            margin-right: 8px;
        }
        .collapsible-header .arrow {
            margin-left: 8px;
            transition: transform 0.3s ease;
        }
        .collapsible-header.open .arrow {
            transform: rotate(180deg);
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }
        .collapsible-content.open {
            max-height: 2000px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 0.9em;
        }
        input[type="date"], input[type="text"], input[type="number"], textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: box-shadow 0.3s ease, border-color 0.3s ease;
        }
        input[type="date"]:focus, input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 162, 227, 0.3);
        }
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        .time-dropdown-container {
            position: relative;
        }
        .time-display {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            background-color: var(--input-bg);
            color: var(--text-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .time-dropdown-container:focus-within .time-display {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 162, 227, 0.3);
        }
        .time-display:after {
            content: '\f078';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            font-size: 12px;
        }
        .time-options {
            position: absolute;
            width: 100%;
            max-height: 200px;
            overflow-y: scroll;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            background-color: var(--dropdown-bg);
            color: var(--dropdown-text);
            z-index: 10;
            margin-top: 4px;
            display: none;
            box-shadow: 0 4px 8px var(--shadow-color);
        }
        .time-options.visible {
            display: block;
        }
        .time-option {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid var(--input-border);
            color: var(--dropdown-text);
        }
        .time-option:hover {
            background-color: var(--dropdown-hover);
        }
        .time-option.selected {
            background-color: rgba(0, 162, 227, 0.1);
            font-weight: 600;
        }
        .radio-group, .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .radio-group label, .checkbox-group label {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 0;
        }
        .radio-group input, .checkbox-group input {
            width: auto;
            margin-right: 8px;
            -webkit-appearance: radio;
            -moz-appearance: radio;
            appearance: radio;
        }
        .btn {
            display: block;
            width: 100%;
            padding: 12px;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        .btn-small {
            padding: 5px 8px;
            font-size: 12px;
            margin: 0;
            display: inline-block;
            width: auto;
            border-radius: 6px;
        }
        .btn-delete {
            background-color: #f08080;
        }
        .btn-delete:hover {
            background-color: #e06666;
        }
        .btn-edit {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-edit:hover {
            background-color: #e0a800;
        }
        #save-btn {
            background-color: var(--accent-color);
            font-size: 20px;
            position: relative;
        }
        #save-btn:hover {
            background-color: #007bb6;
        }
        .btn-save-anim {
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .btn-save-anim .btn-text, .btn-save-anim .btn-icon {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .btn-save-anim .btn-text {
            position: absolute;
            opacity: 1;
            transform: translateY(0);
        }
        .btn-save-anim .btn-icon {
            position: absolute;
            opacity: 0;
            transform: translateY(100%);
        }
        .btn-save-anim.saved .btn-text {
            opacity: 0;
            transform: translateY(-100%);
        }
        .btn-save-anim.saved .btn-icon {
            opacity: 1;
            transform: translateY(0);
        }
        .btn-green {
            background-color: #22a36b;
        }
        .btn-green:hover {
            background-color: #1a7e52;
        }
        .btn-pdf {
            background-color: #b30000;
        }
        .btn-pdf:hover {
            background-color: #800000;
        }
        .btn-backup {
            background-color: #337ab7;
        }
        .btn-backup:hover {
            background-color: #286090;
        }
        .button-group-responsive {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        #results {
            margin-top: 20px;
            padding: 12px;
            background-color: var(--results-bg);
            border-radius: 8px;
        }
        #results h3 {
            margin-top: 0;
            color: var(--accent-color);
            font-size: 1.1em;
        }
        #results p {
            margin: 4px 0;
            font-size: 16px;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: var(--bg-container);
            font-size: 12px;
        }
        th, td {
            padding: 8px;
            border: 1px solid var(--input-border);
            text-align: left;
        }
        th {
            background-color: var(--table-head);
            font-weight: 600;
            white-space: nowrap;
        }
        th:last-child {
            text-align: center;
        }
        td:first-child {
            white-space: nowrap;
        }
        tr:nth-child(even) {
            background-color: var(--table-even);
        }
        #register-table tbody tr {
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInRow 0.5s ease-out forwards;
        }
        @keyframes fadeInRow {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .action-buttons-cell {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }
        #notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            opacity: 0;
            transform: translateY(100px);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            z-index: 100;
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        #notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        #notification.success {
            background-color: var(--notification-success);
        }
        #notification.error {
            background-color: var(--notification-error);
        }
        .export-options-container {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: flex-start;
        }
        .export-options-container > select {
            width: 45%;
        }
        .export-options-container > .multiselect-dropdown {
            width: 45%;
        }
        select {
            padding: 0 10px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: var(--input-bg);
            color: var(--text-color);
            height: 40px;
        }
        .multiselect-dropdown {
            position: relative;
            cursor: pointer;
            user-select: none;
        }
        .multiselect-selected {
            width: 100%;
            padding: 0 10px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            background-color: var(--input-bg);
            color: var(--text-color);
            height: 40px;
            font-size: 14px;
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
            gap: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            line-height: 40px;
            transition: box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .multiselect-selected:after {
            content: '\f078';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            font-size: 12px;
            margin-left: auto;
            flex-shrink: 0;
        }
        .multiselect-options {
            position: absolute;
            width: 100%;
            top: 100%;
            left: 0;
            right: 0;
            background-color: var(--dropdown-bg);
            color: var(--dropdown-text);
            border: 1px solid var(--input-border);
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
            box-sizing: border-box;
            box-shadow: 0 4px 8px var(--shadow-color);
        }
        .multiselect-options.visible {
            display: block;
        }
        .multiselect-option {
            padding: 10px;
            display: flex;
            align-items: center;
            color: var(--dropdown-text);
        }
        .multiselect-option input[type="checkbox"] {
            margin-right: 10px;
            -webkit-appearance: checkbox;
        }
        .multiselect-option:hover {
            background-color: var(--dropdown-hover);
        }
        .multiselect-dropdown.disabled {
            opacity: 0.6;
            pointer-events: none;
        }
        @media (min-width: 600px) {
            .multiselect-selected,
            .export-options-container > select {
                font-size: 16px;
                height: 48px;
                line-height: 48px;
            }
            .multiselect-option {
                font-size: 16px;
            }
        }
        .chart-container {
            margin: 20px 0;
            text-align: center;
        }
        #gross-net-table th:nth-child(2),
        #gross-net-table td:nth-child(2),
        #gross-net-table th:nth-child(3),
        #gross-net-table td:nth-child(3),
        #gross-net-table th:nth-child(4),
        #gross-net-table td:nth-child(4),
        #gross-net-table th:nth-child(5),
        #gross-net-table td:nth-child(5),
        #gross-net-table th:nth-child(6),
        #gross-net-table td:nth-child(6) {
            min-width: 120px;
            white-space: nowrap;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="logo-text">TECNOSISTEM</div>
    <div class="form-group">
        <label for="date">Seleziona Giorno:</label>
        <input type="date" id="date">
    </div>

    <div class="form-group">
        <label for="workModeSelect">Modalità di lavoro:</label>
        <select id="workModeSelect">
            <option value="">Seleziona...</option>
            <option value="In Sede">In sede</option>
            <option value="Rientro">Trasferta (Rientro)</option>
            <option value="Pernottamento">Trasferta (Pernottamento)</option>
            <option value="Estero">Trasferta (Estero)</option>
        </select>
    </div>

    <div class="form-group">
        <label for="absenceType">Tipo di Assenza:</label>
        <select id="absenceType">
            <option value="">Nessuna assenza</option>
            <option value="Ferie">Ferie</option>
            <option value="Permesso">Permesso</option>
            <option value="Malattia">Malattia</option>
        </select>
    </div>

    <div id="work-fields">
        <div class="form-group">
            <label>Orario Inizio:</label>
            <div class="time-dropdown-container">
                <div id="startTimeDisplay" class="time-display" data-value="">Seleziona orario</div>
                <div id="startTimeOptions" class="time-options"></div>
            </div>
        </div>
        <div class="form-group">
            <label>Orario Fine:</label>
            <div class="time-dropdown-container">
                <div id="endTimeDisplay" class="time-display" data-value="">Seleziona orario</div>
                <div id="endTimeOptions" class="time-options"></div>
            </div>
        </div>
        <div class="checkbox-group">
            <input type="checkbox" id="lunchBreak">
            <label for="lunchBreak">Pausa pranzo (1 ora)</label>
        </div>
    </div>

    <div class="form-group">
        <label for="location">Luogo Intervento:</label>
        <input type="text" id="location" list="location-suggestions">
        <datalist id="location-suggestions"></datalist>
    </div>
    <div class="form-group">
        <label for="notes">Note:</label>
        <textarea id="notes"></textarea>
    </div>
    
    <div class="form-group" id="economic-values-edit" style="display: none;">
        <h3>Valori Economici</h3>
        <div class="form-group">
            <label for="editGrossBaseSalaryInput">Paga Base Mensile Lorda (€):</label>
            <input type="number" id="editGrossBaseSalaryInput" step="0.01" min="0">
        </div>
        <div class="form-group">
            <label for="editOvertimeRateInput">Paga Oraria Straordinario 25% (€):</label>
            <input type="number" id="editOvertimeRateInput" step="0.01" min="0">
        </div>
        <div class="form-group">
            <label for="editOvertimeRate50Input">Paga Oraria Straordinario 50% (€):</label>
            <input type="number" id="editOvertimeRate50Input" step="0.01" min="0">
        </div>
        <div class="form-group">
            <label for="editTripAllowanceReturnInput">Diaria Trasferta Rientro (€):</label>
            <input type="number" id="editTripAllowanceReturnInput" step="0.01" min="0">
        </div>
        <div class="form-group">
            <label for="editTripAllowanceOvernightInput">Diaria Trasferta Pernottamento (€):</label>
            <input type="number" id="editTripAllowanceOvernightInput" step="0.01" min="0">
        </div>
        <div class="form-group">
            <label for="editTripAllowanceAbroadInput">Diaria Trasferta Estero (€):</label>
            <input type="number" id="editTripAllowanceAbroadInput" step="0.01" min="0">
        </div>
        <div class="form-group">
            <label for="editTaxRateInput">Aliquota Fiscale (IRPEF, ecc.) in %:</label>
            <input type="number" id="editTaxRateInput" step="0.1" min="0" max="100">
        </div>
        <div class="form-group">
            <label for="editThirteenthMonthInput">Tredicesima Mensilità Lorda (€):</label>
            <input type="number" id="editThirteenthMonthInput" step="0.01" min="0">
        </div>
    </div>
    
    <div id="results">
        <h3>Riepilogo giornaliero</h3>
        <p id="totalHoursContainer"><strong>Ore totali:</strong> <span id="totalHours">0</span></p>
        <p id="overtimeHoursContainer"><strong>Ore straordinarie:</strong> <span id="overtimeHours">0</span></p>
        <p id="absenceHoursContainer" style="display: none;"><strong>Ore di assenza:</strong> <span id="absenceHours">0</span></p>
    </div>
    
    <button id="save-btn" class="btn btn-save-anim">
        <span class="btn-text"><i class="fas fa-save"></i> Salva</span>
        <span class="btn-icon"><i class="fas fa-check"></i></span>
    </button>
    
    <hr>
    
    <h2>Riepilogo Mensile</h2>
    <div class="chart-container">
        <canvas id="monthlyChart"></canvas>
    </div>
    
    <div class="table-container">
        <table id="monthly-summary-table">
            <thead>
                <tr>
                    <th>Mese</th>
                    <th>Ore Tot.</th>
                    <th>Ore Str.</th>
                    <th>Trasferta</th>
                    <th>Sede</th>
                    <th>Assenze</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    
    <hr>
    
    <h2 class="collapsible-header" id="toggle-settings"><i class="fas fa-cog"></i> Impostazioni Avanzate <span class="arrow"><i class="fas fa-chevron-down"></i></span></h2>
    <div class="collapsible-content" id="settings-content">
        <p>Modifica i valori usati per i calcoli economici. I cambiamenti verranno salvati.</p>
        <div class="form-group">
            <label for="grossBaseSalaryInput">Paga Base Mensile Lorda (€):</label>
            <input type="number" id="grossBaseSalaryInput" step="0.01" min="0">
        </div>
        <div class="form-group">
            <label for="overtimeRateInput">Paga Oraria Straordinario 25% (€):</label>
            <input type="number" id="overtimeRateInput" step="0.01" min="0">
        </div>
        <div class="form-group">
            <label for="overtimeRate50Input">Paga Oraria Straordinario 50% (€):</label>
            <input type="number" id="overtimeRate50Input" step="0.01" min="0">
        </div>
        <div class="form-group">
            <label for="tripAllowanceReturnInput">Diaria Trasferta Rientro (€):</label>
            <input type="number" id="tripAllowanceReturnInput" step="0.01" min="0">
        </div>
        <div class="form-group">
            <label for="tripAllowanceOvernightInput">Diaria Trasferta Pernottamento (€):</label>
            <input type="number" id="tripAllowanceOvernightInput" step="0.01" min="0">
        </div>
        <div class="form-group">
            <label for="tripAllowanceAbroadInput">Diaria Trasferta Estero (€):</label>
            <input type="number" id="tripAllowanceAbroadInput" step="0.01" min="0">
        </div>
        <div class="form-group">
            <label for="taxRateInput">Aliquota Fiscale (IRPEF, ecc.) in % (fino al 2025):</label>
            <input type="number" id="taxRateInput" step="0.1" min="0" max="100">
        </div>
        <div class="form-group">
            <label for="thirteenthMonthInput">Tredicesima Mensilità Lorda (€):</label>
            <input type="number" id="thirteenthMonthInput" step="0.01" min="0">
        </div>
    </div>
    
    <hr>
    
    <h2 class="collapsible-header" id="toggle-gross-net"><i class="fas fa-money-bill-wave"></i> Riepilogo Lordo/Netto <span class="arrow"><i class="fas fa-chevron-down"></i></span></h2>
    <div class="collapsible-content" id="gross-net-content">
        <div class="form-group">
            <label for="gross-net-year">Filtra per Anno:</label>
            <select id="gross-net-year">
                <option value="">Tutti gli Anni</option>
            </select>
        </div>
        <div class="table-container">
            <table id="gross-net-table">
                <thead>
                    <tr>
                        <th>Mese</th>
                        <th>Lordo</th>
                        <th>Netto (stimato)</th>
                        <th>Straordinari</th>
                        <th>Diarie</th>
                        <th>Detrazioni</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <div class="chart-container">
            <canvas id="grossNetChart"></canvas>
        </div>
        <p style="font-size: 0.8em; color: var(--text-color);">Nota: Stime approssimative. Consulta un professionista per calcoli fiscali precisi.</p>
        <button id="export-gross-net-pdf" class="btn btn-pdf"><i class="fas fa-file-pdf"></i> Esporta Riepilogo in PDF</button>
    </div>
    
    <hr>
    
    <h2 class="collapsible-header" id="toggle-register"><i class="fas fa-clipboard"></i> Registro Completo <span class="arrow"><i class="fas fa-chevron-down"></i></span></h2>
    <div class="collapsible-content" id="register-content">
        <div class="form-group" style="margin-top: 20px;">
            <label for="search-input">Cerca nel registro:</label>
            <input type="text" id="search-input" placeholder="Cerca per data, luogo o note...">
        </div>
        <div class="form-group" style="margin-top: 20px;">
            <label for="filter-month-year">Filtra per Mese(i) o Anno:</label>
            <div class="export-options-container">
                <select id="filter-year">
                    <option value="">Tutti gli Anni</option>
                </select>
                <div class="multiselect-dropdown" id="filter-month-container">
                    <div class="multiselect-selected">Tutti i Mesi</div>
                    <div class="multiselect-options" id="filter-month-options"></div>
                </div>
            </div>
        </div>
        <div class="table-container">
            <table id="register-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Inizio</th>
                        <th>Fine</th>
                        <th>Assenza</th>
                        <th>Totali</th>
                        <th>Str.</th>
                        <th>Modalità</th>
                        <th>Luogo</th>
                        <th>Note</th>
                        <th>Azione</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
    
    <hr>
    
    <h2><i class="fas fa-file-export"></i> Esporta e gestisci i dati</h2>
    
    <div class="form-group" style="margin-top: 20px;">
        <label>Esporta un periodo specifico:</label>
        <div class="export-options-container">
            <select id="export-year">
                <option value="">Seleziona Anno</option>
            </select>
            <div class="multiselect-dropdown" id="multiselect-month-container">
                <div class="multiselect-selected">Seleziona Mese(i)</div>
                <div class="multiselect-options" id="multiselect-month-options"></div>
            </div>
        </div>
    </div>
    <div class="button-group-responsive">
        <button id="export-selected-btn" class="btn btn-green"><i class="fas fa-file-csv"></i> Esporta in CSV</button>
        <button id="export-selected-pdf-btn" class="btn btn-pdf"><i class="fas fa-file-pdf"></i> Esporta in PDF</button>
    </div>
    <div class="button-group-responsive">
        <button id="export-all-btn" class="btn btn-green"><i class="fas fa-file-csv"></i> Esporta tutto in CSV</button>
        <button id="export-pdf-btn" class="btn btn-pdf"><i class="fas fa-file-pdf"></i> Esporta tutto in PDF</button>
    </div>
    
    <div class="button-group-responsive" style="margin-top: 20px;">
        <button id="export-data-btn" class="btn btn-backup"><i class="fas fa-download"></i> Crea Backup</button>
        <button id="import-data-btn" class="btn btn-backup"><i class="fas fa-upload"></i> Importa Backup</button>
        <input type="file" id="import-file" accept=".json" style="display: none;">
    </div>
    
</div>

<div id="notification"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Selezioni elementi del DOM
    const dateInput = document.getElementById('date');
    const workModeSelect = document.getElementById('workModeSelect');
    const absenceTypeSelect = document.getElementById('absenceType');
    const workFields = document.getElementById('work-fields');
    const startTimeDisplay = document.getElementById('startTimeDisplay');
    const startTimeOptions = document.getElementById('startTimeOptions');
    const endTimeDisplay = document.getElementById('endTimeDisplay');
    const endTimeOptions = document.getElementById('endTimeOptions');
    const lunchBreakCheckbox = document.getElementById('lunchBreak');
    const locationInput = document.getElementById('location');
    const notesInput = document.getElementById('notes');
    const totalHoursSpan = document.getElementById('totalHours');
    const overtimeHoursSpan = document.getElementById('overtimeHours');
    const absenceHoursSpan = document.getElementById('absenceHours');
    const totalHoursContainer = document.getElementById('totalHoursContainer');
    const overtimeHoursContainer = document.getElementById('overtimeHoursContainer');
    const absenceHoursContainer = document.getElementById('absenceHoursContainer');
    const saveButton = document.getElementById('save-btn');
    const registerBody = document.querySelector('#register-table tbody');
    const monthlySummaryBody = document.querySelector('#monthly-summary-table tbody');
    const locationDatalist = document.getElementById('location-suggestions');
    const toggleRegisterHeader = document.getElementById('toggle-register');
    const registerContent = document.getElementById('register-content');
    const notification = document.getElementById('notification');
    const searchInput = document.getElementById('search-input');
    const standardWorkDay = 8;
    const standardStartTime = '08:00';
    const standardEndTime = '17:00';
    let registerData = [];
    
    // Variabili per i calcoli economici (inizializzate con valori dalla foto)
    let grossBaseSalary = 3480.79;
    let overtimeRate = 21.53; // Straordinario 25%
    let overtimeRate50 = 25.83; // Straordinario 50%
    let tripAllowanceReturn = 30.00;
    let tripAllowanceOvernight = 60.00;
    let tripAllowanceAbroad = 109.00; // Diaria Estero
    let taxRate = 0.3625;
    let thirteenthMonth = 3480.79;
    const socialSecurityRate = 0.0949;
    
    // Elementi del menu impostazioni
    const toggleSettingsHeader = document.getElementById('toggle-settings');
    const settingsContent = document.getElementById('settings-content');
    const grossBaseSalaryInput = document.getElementById('grossBaseSalaryInput');
    const overtimeRateInput = document.getElementById('overtimeRateInput');
    const overtimeRate50Input = document.getElementById('overtimeRate50Input');
    const tripAllowanceReturnInput = document.getElementById('tripAllowanceReturnInput');
    const tripAllowanceOvernightInput = document.getElementById('tripAllowanceOvernightInput');
    const tripAllowanceAbroadInput = document.getElementById('tripAllowanceAbroadInput');
    const taxRateInput = document.getElementById('taxRateInput');
    const thirteenthMonthInput = document.getElementById('thirteenthMonthInput');

    // Elementi di esportazione e filtro
    const exportYearSelect = document.getElementById('export-year');
    const multiselectMonthContainer = document.getElementById('multiselect-month-container');
    const multiselectMonthSelected = document.querySelector('#multiselect-month-container .multiselect-selected');
    const multiselectMonthOptions = document.getElementById('multiselect-month-options');
    const exportSelectedButton = document.getElementById('export-selected-btn');
    const exportSelectedPdfButton = document.getElementById('export-selected-pdf-btn');
    const exportAllButton = document.getElementById('export-all-btn');
    const exportPdfButton = document.getElementById('export-pdf-btn');
    const filterYearSelect = document.getElementById('filter-year');
    const filterMonthContainer = document.getElementById('filter-month-container');
    const filterMonthSelected = document.querySelector('#filter-month-container .multiselect-selected');
    const filterMonthOptions = document.getElementById('filter-month-options');
    const exportDataBtn = document.getElementById('export-data-btn');
    const importDataBtn = document.getElementById('import-data-btn');
    const importFile = document.getElementById('import-file');
    
    // Elementi del grafico
    const monthlyChartCanvas = document.getElementById('monthlyChart');
    let monthlyChart = null;

    // Elementi del riepilogo lordo/netto
    const toggleGrossNetHeader = document.getElementById('toggle-gross-net');
    const grossNetContent = document.getElementById('gross-net-content');
    const grossNetBody = document.querySelector('#gross-net-table tbody');
    const grossNetYearSelect = document.getElementById('gross-net-year');
    const exportGrossNetPdfButton = document.getElementById('export-gross-net-pdf');
    let grossNetChart = null;

    // Elementi per modifica economica
    const economicValuesEdit = document.getElementById('economic-values-edit');
    const editGrossBaseSalaryInput = document.getElementById('editGrossBaseSalaryInput');
    const editOvertimeRateInput = document.getElementById('editOvertimeRateInput');
    const editOvertimeRate50Input = document.getElementById('editOvertimeRate50Input');
    const editTripAllowanceReturnInput = document.getElementById('editTripAllowanceReturnInput');
    const editTripAllowanceOvernightInput = document.getElementById('editTripAllowanceOvernightInput');
    const editTripAllowanceAbroadInput = document.getElementById('editTripAllowanceAbroadInput');
    const editTaxRateInput = document.getElementById('editTaxRateInput');
    const editThirteenthMonthInput = document.getElementById('editThirteenthMonthInput');

    // Chiavi per localStorage
    const STORAGE_KEY = 'registroOrario';
    const SETTINGS_KEY = 'registroSettings';

    // Dati simulati dalla foto (sostituisci con i valori reali se necessario)
    const photoData = {
        grossBaseSalary: 3480.79,
        overtimeRate: 21.53,
        overtimeRate50: 25.83,
        tripAllowanceReturn: 30.00,
        tripAllowanceOvernight: 60.00,
        tripAllowanceAbroad: 109.00,
        taxRate: 0.3625,
        thirteenthMonth: 3480.79
    };

    // Funzioni di utilità
    function showNotification(message, type) {
        notification.innerHTML = message;
        notification.className = '';
        notification.classList.add('show', type);
        setTimeout(() => {
            notification.classList.remove('show');
        }, 8000);
    }

    function formatNumber(number) {
        return number.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, '.').replace('.', ',');
    }

    function generateTimeOptions() {
        let optionsHtml = '';
        for (let h = 0; h < 24; h++) {
            for (let m = 0; m < 60; m += 30) {
                const hour = String(h).padStart(2, '0');
                const minute = String(m).padStart(2, '0');
                const time = `${hour}:${minute}`;
                optionsHtml += `<div class="time-option" data-value="${time}">${time}</div>`;
            }
        }
        startTimeOptions.innerHTML = optionsHtml;
        endTimeOptions.innerHTML = optionsHtml;
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        const [year, month, day] = dateString.split('-');
        return `${day}-${month}-${year.substring(2)}`;
    }

    function setTimeDropdown(display, options, time) {
        display.textContent = time;
        display.setAttribute('data-value', time);
        options.querySelectorAll('.time-option').forEach(option => {
            if (option.getAttribute('data-value') === time) {
                option.classList.add('selected');
            } else {
                option.classList.remove('selected');
            }
        });
    }

    function clearTimeDropdowns() {
        setTimeDropdown(startTimeDisplay, startTimeOptions, 'Seleziona orario');
        startTimeDisplay.setAttribute('data-value', '');
        setTimeDropdown(endTimeDisplay, endTimeOptions, 'Seleziona orario');
        endTimeDisplay.setAttribute('data-value', '');
    }

    function calculateHours() {
        const absenceType = absenceTypeSelect.value;
        const startTime = startTimeDisplay.getAttribute('data-value');
        const endTime = endTimeDisplay.getAttribute('data-value');
        const lunchBreak = lunchBreakCheckbox.checked;

        if (absenceType) {
            totalHoursSpan.textContent = '0';
            overtimeHoursSpan.textContent = '0';
            absenceHoursSpan.textContent = '8';
            totalHoursContainer.style.display = 'none';
            overtimeHoursContainer.style.display = 'none';
            absenceHoursContainer.style.display = 'block';
            return;
        }
        
        totalHoursContainer.style.display = 'block';
        overtimeHoursContainer.style.display = 'block';
        absenceHoursContainer.style.display = 'none';

        if (startTime && endTime && dateInput.value) {
            const start = new Date(`2025-01-01T${startTime}:00`);
            const end = new Date(`2025-01-01T${endTime}:00`);
            if (end < start) {
                end.setDate(end.getDate() + 1);
            }
            let totalMilliseconds = end - start;
            let totalHours = totalMilliseconds / (1000 * 60 * 60);
            if (lunchBreak) {
                totalHours -= 1;
            }
            totalHours = Math.max(0, totalHours);
            
            const totalHoursFixed = totalHours.toFixed(2);
            totalHoursSpan.textContent = totalHoursFixed;
            
            const dayOfWeek = new Date(dateInput.value + 'T12:00:00').getDay();
            const isWeekend = (dayOfWeek === 6 || dayOfWeek === 0);
            let overtimeHours = 0;
            
            if (isWeekend) {
                overtimeHours = totalHours;
                overtimeHoursContainer.querySelector('strong').textContent = 'Ore straordinarie (50%):';
            } else {
                if (totalHours > standardWorkDay) {
                    overtimeHours = totalHours - standardWorkDay;
                }
                overtimeHoursContainer.querySelector('strong').textContent = 'Ore straordinarie:';
            }
            overtimeHoursSpan.textContent = overtimeHours.toFixed(2);

        } else {
            totalHoursSpan.textContent = '0';
            overtimeHoursSpan.textContent = '0';
        }
    }

    function createRow(entry) {
        const row = document.createElement('tr');
        row.setAttribute('data-date', entry.date);
        const totalOvertime = (entry.overtimeHours || 0) + (entry.overtimeHours50 || 0);
        row.innerHTML = `
            <td>${formatDate(entry.date)}</td>
            <td>${entry.startTime || '-'}</td>
            <td>${entry.endTime || '-'}</td>
            <td>${entry.absenceType || '-'}</td>
            <td>${entry.totalHours.toFixed(2)}</td>
            <td>${totalOvertime.toFixed(2)}</td>
            <td>${entry.workMode || '-'}</td>
            <td>${entry.location}</td>
            <td>${entry.notes || ''}</td>
            <td class="action-buttons-cell">
                <button class="btn-small btn-edit" data-date="${entry.date}"><i class="fas fa-pencil-alt"></i></button>
                <button class="btn-small btn-delete" data-date="${entry.date}"><i class="fas fa-trash"></i></button>
            </td>
        `;
        return row;
    }

    function saveEntry() {
        const date = dateInput.value;
        if (!date) {
            showNotification('Per favore, seleziona una data.', 'error');
            return;
        }

        const absenceType = absenceTypeSelect.value;
        const workMode = workModeSelect.value;
        let startTime, endTime, lunchBreak, location, notes, totalHours, overtimeHours, absenceHours;
        let overtimeHours50 = 0;

        if (absenceType) {
            startTime = standardStartTime;
            endTime = standardEndTime;
            lunchBreak = true;
            location = locationInput.value || 'Assenza';
            notes = notesInput.value;
            totalHours = 0;
            overtimeHours = 0;
            absenceHours = 8;
        } else {
            startTime = startTimeDisplay.getAttribute('data-value');
            endTime = endTimeDisplay.getAttribute('data-value');
            if (!startTime || !endTime || !workMode) {
                showNotification('Per favore, compila tutti i campi richiesti.', 'error');
                return;
            }
            const start = new Date(`2025-01-01T${startTime}:00`);
            const end = new Date(`2025-01-01T${endTime}:00`);
            if (end < start) {
                showNotification('L\'orario di fine non può essere precedente a quello di inizio.', 'error');
                return;
            }

            lunchBreak = lunchBreakCheckbox.checked;
            location = locationInput.value;
            notes = notesInput.value;
            totalHours = parseFloat(totalHoursSpan.textContent);
            absenceHours = 0;
            
            const dayOfWeek = new Date(date + 'T12:00:00').getDay();
            const isWeekend = (dayOfWeek === 6 || dayOfWeek === 0);

            if (isWeekend) {
                overtimeHours50 = totalHours;
                overtimeHours = 0;
            } else {
                overtimeHours = totalHours > standardWorkDay ? totalHours - standardWorkDay : 0;
            }
        }
        
        saveButton.classList.add('saved');

        const economicValuesEdit = document.getElementById('economic-values-edit');
        const economicValues = {
            grossBaseSalary: economicValuesEdit.style.display === 'block' ? parseFloat(editGrossBaseSalaryInput.value) || grossBaseSalary : grossBaseSalary,
            overtimeRate: economicValuesEdit.style.display === 'block' ? parseFloat(editOvertimeRateInput.value) || overtimeRate : overtimeRate,
            overtimeRate50: economicValuesEdit.style.display === 'block' ? parseFloat(editOvertimeRate50Input.value) || overtimeRate50 : overtimeRate50,
            tripAllowanceReturn: economicValuesEdit.style.display === 'block' ? parseFloat(editTripAllowanceReturnInput.value) || tripAllowanceReturn : tripAllowanceReturn,
            tripAllowanceOvernight: economicValuesEdit.style.display === 'block' ? parseFloat(editTripAllowanceOvernightInput.value) || tripAllowanceOvernight : tripAllowanceOvernight,
            tripAllowanceAbroad: economicValuesEdit.style.display === 'block' ? parseFloat(editTripAllowanceAbroadInput.value) || tripAllowanceAbroad : tripAllowanceAbroad,
            taxRate: economicValuesEdit.style.display === 'block' ? parseFloat(editTaxRateInput.value) / 100 || taxRate : taxRate,
            thirteenthMonth: economicValuesEdit.style.display === 'block' ? parseFloat(editThirteenthMonthInput.value) || thirteenthMonth : thirteenthMonth
        };

        const newEntry = {
            date: date,
            startTime: startTime,
            endTime: endTime,
            totalHours: totalHours,
            overtimeHours: overtimeHours,
            overtimeHours50: overtimeHours50,
            workMode: workMode,
            lunchBreak: lunchBreak,
            location: location,
            notes: notes,
            absenceType: absenceType,
            absenceHours: absenceHours,
            economicValues: economicValues
        };

        const existingIndex = registerData.findIndex(entry => entry.date === date);
        if (existingIndex !== -1) {
            registerData[existingIndex] = newEntry;
        } else {
            registerData.push(newEntry);
        }
        registerData.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(registerData));
        } catch (e) {
            showNotification('ERRORE: Impossibile salvare i dati.', 'error');
            console.error(e);
            return;
        }
        renderAllData();
        showNotification('Dati salvati nel registro!', 'success');
        
        setTimeout(() => {
            saveButton.classList.remove('saved');
            dateInput.value = new Date().toISOString().split('T')[0];
            workModeSelect.value = '';
            absenceTypeSelect.value = '';
            clearTimeDropdowns();
            lunchBreakCheckbox.checked = false;
            locationInput.value = '';
            notesInput.value = '';
            economicValuesEdit.style.display = 'none';
            calculateHours();
        }, 1000);
    }

    function deleteEntry(date) {
        if (confirm(`Sei sicuro di voler cancellare l'inserimento del giorno ${formatDate(date)}?`)) {
            registerData = registerData.filter(entry => entry.date !== date);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(registerData));
            renderAllData();
            showNotification('Dato cancellato.', 'success');
        }
    }

    function editEntry(date) {
        const entryToEdit = registerData.find(entry => entry.date === date);
        if (entryToEdit) {
            dateInput.value = entryToEdit.date;
            workModeSelect.value = entryToEdit.workMode || '';
            absenceTypeSelect.value = entryToEdit.absenceType || '';
            
            if (entryToEdit.startTime) setTimeDropdown(startTimeDisplay, startTimeOptions, entryToEdit.startTime);
            if (entryToEdit.endTime) setTimeDropdown(endTimeDisplay, endTimeOptions, entryToEdit.endTime);
            
            lunchBreakCheckbox.checked = entryToEdit.lunchBreak || false;
            locationInput.value = entryToEdit.location || '';
            notesInput.value = entryToEdit.notes || '';
            
            economicValuesEdit.style.display = 'block';
            editGrossBaseSalaryInput.value = entryToEdit.economicValues?.grossBaseSalary || grossBaseSalary;
            editOvertimeRateInput.value = entryToEdit.economicValues?.overtimeRate || overtimeRate;
            editOvertimeRate50Input.value = entryToEdit.economicValues?.overtimeRate50 || overtimeRate50;
            editTripAllowanceReturnInput.value = entryToEdit.economicValues?.tripAllowanceReturn || tripAllowanceReturn;
            editTripAllowanceOvernightInput.value = entryToEdit.economicValues?.tripAllowanceOvernight || tripAllowanceOvernight;
            editTripAllowanceAbroadInput.value = entryToEdit.economicValues?.tripAllowanceAbroad || tripAllowanceAbroad;
            editTaxRateInput.value = (entryToEdit.economicValues?.taxRate || taxRate) * 100;
            editThirteenthMonthInput.value = entryToEdit.economicValues?.thirteenthMonth || thirteenthMonth;
            
            calculateHours();
            toggleRegisterHeader.click();
        }
    }

    function renderMonthlySummary() {
        monthlySummaryBody.innerHTML = '';
        const monthlyData = {};
        registerData.forEach(entry => {
            const date = new Date(entry.date);
            const monthYear = `${date.getMonth() + 1}-${date.getFullYear()}`;
            if (!monthlyData[monthYear]) {
                monthlyData[monthYear] = { totalHours: 0, overtimeHours: 0, overtimeHours50: 0, tripDays: 0, workDays: 0, absenceDays: 0 };
            }
            monthlyData[monthYear].totalHours += entry.totalHours || 0;
            monthlyData[monthYear].overtimeHours += entry.overtimeHours || 0;
            monthlyData[monthYear].overtimeHours50 += entry.overtimeHours50 || 0;
            if (entry.workMode && entry.workMode !== 'In Sede') monthlyData[monthYear].tripDays++;
            if (entry.workMode === 'In Sede') monthlyData[monthYear].workDays++;
            if (entry.absenceType) monthlyData[monthYear].absenceDays++;
        });

        Object.entries(monthlyData).forEach(([monthYear, data]) => {
            const [month, year] = monthYear.split('-');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${new Date(year, month - 1).toLocaleString('it-IT', { month: 'long' })} ${year}</td>
                <td>${data.totalHours.toFixed(2)}</td>
                <td>${(data.overtimeHours + data.overtimeHours50).toFixed(2)}</td>
                <td>${data.tripDays}</td>
                <td>${data.workDays}</td>
                <td>${data.absenceDays}</td>
            `;
            monthlySummaryBody.appendChild(row);
        });
    }

    function renderGrossNetSummary() {
        grossNetBody.innerHTML = '';
        const yearlyData = {};
        registerData.forEach(entry => {
            const date = new Date(entry.date);
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            if (!yearlyData[year]) yearlyData[year] = {};
            if (!yearlyData[year][month]) {
                yearlyData[year][month] = { gross: 0, net: 0, overtime: 0, allowances: 0, deductions: 0 };
            }
            const economicValues = entry.economicValues || {
                grossBaseSalary,
                overtimeRate,
                overtimeRate50,
                tripAllowanceReturn,
                tripAllowanceOvernight,
                tripAllowanceAbroad,
                taxRate,
                thirteenthMonth
            };
            const monthlyHours = entry.totalHours || 0;
            const overtimeHours = entry.overtimeHours || 0;
            const overtimeHours50 = entry.overtimeHours50 || 0;
            const allowance = entry.workMode === 'Rientro' ? economicValues.tripAllowanceReturn :
                            entry.workMode === 'Pernottamento' ? economicValues.tripAllowanceOvernight :
                            entry.workMode === 'Estero' ? economicValues.tripAllowanceAbroad : 0;

            const baseSalaryPerHour = economicValues.grossBaseSalary / (20 * 8); // 20 giorni lavorativi medi
            const grossBase = (monthlyHours - overtimeHours) * baseSalaryPerHour;
            const grossOvertime = overtimeHours * economicValues.overtimeRate + overtimeHours50 * economicValues.overtimeRate50;
            const grossTotal = grossBase + grossOvertime + allowance + (economicValues.thirteenthMonth / 12);
            const deductions = grossTotal * (economicValues.taxRate + socialSecurityRate);
            const netTotal = grossTotal - deductions;

            yearlyData[year][month].gross += grossTotal;
            yearlyData[year][month].net += netTotal;
            yearlyData[year][month].overtime += grossOvertime;
            yearlyData[year][month].allowances += allowance;
            yearlyData[year][month].deductions += deductions;
        });

        Object.entries(yearlyData).forEach(([year, months]) => {
            Object.entries(months).forEach(([month, data]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(year, month - 1).toLocaleString('it-IT', { month: 'long' })} ${year}</td>
                    <td>${formatNumber(data.gross)}</td>
                    <td>${formatNumber(data.net)}</td>
                    <td>${formatNumber(data.overtime)}</td>
                    <td>${formatNumber(data.allowances)}</td>
                    <td>${formatNumber(data.deductions)}</td>
                `;
                grossNetBody.appendChild(row);
            });
        });
    }

    function renderAllData() {
        registerBody.innerHTML = '';
        registerData.forEach(entry => {
            const row = createRow(entry);
            registerBody.appendChild(row);
        });
        renderMonthlySummary();
        renderGrossNetSummary();
        updateYearOptions();
        updateFilterOptions();
        updateExportOptions();
    }

    function updateYearOptions() {
        const years = [...new Set(registerData.map(entry => new Date(entry.date).getFullYear()))].sort((a, b) => b - a);
        [filterYearSelect, exportYearSelect, grossNetYearSelect].forEach(select => {
            select.innerHTML = '<option value="">Tutti gli Anni</option>';
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                select.appendChild(option);
            });
        });
    }

    function updateFilterOptions() {
        const months = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
        filterMonthOptions.innerHTML = '';
        months.forEach((month, index) => {
            const option = document.createElement('div');
            option.className = 'multiselect-option';
            option.innerHTML = `<input type="checkbox" value="${index + 1}" id="filter-month-${index + 1}"> <label for="filter-month-${index + 1}">${month}</label>`;
            filterMonthOptions.appendChild(option);
        });
        filterMonthOptions.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', filterRegister);
        });
    }

    function updateExportOptions() {
        const months = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
        multiselectMonthOptions.innerHTML = '';
        months.forEach((month, index) => {
            const option = document.createElement('div');
            option.className = 'multiselect-option';
            option.innerHTML = `<input type="checkbox" value="${index + 1}" id="export-month-${index + 1}"> <label for="export-month-${index + 1}">${month}</label>`;
            multiselectMonthOptions.appendChild(option);
        });
        multiselectMonthOptions.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectedMonths);
        });
    }

    function filterRegister() {
        const year = filterYearSelect.value;
        const selectedMonths = Array.from(filterMonthOptions.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        registerBody.querySelectorAll('tr').forEach(row => {
            const date = new Date(row.getAttribute('data-date'));
            const month = date.getMonth() + 1;
            const rowYear = date.getFullYear();
            const matchesYear = !year || rowYear == year;
            const matchesMonth = selectedMonths.length === 0 || selectedMonths.includes(month.toString());
            row.style.display = matchesYear && matchesMonth ? '' : 'none';
        });
    }

    function updateSelectedMonths() {
        const selected = Array.from(multiselectMonthOptions.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.nextElementSibling.textContent);
        multiselectMonthSelected.textContent = selected.length ? selected.join(', ') : 'Seleziona Mese(i)';
    }

    function exportToCSV(data, filename) {
        const headers = ['Data', 'Inizio', 'Fine', 'Assenza', 'Ore Totali', 'Ore Straordinarie', 'Modalità', 'Luogo', 'Note'];
        const csv = [
            headers.join(','),
            ...data.map(entry =>
                [
                    formatDate(entry.date),
                    entry.startTime || '',
                    entry.endTime || '',
                    entry.absenceType || '',
                    entry.totalHours.toFixed(2),
                    ((entry.overtimeHours || 0) + (entry.overtimeHours50 || 0)).toFixed(2),
                    entry.workMode || '',
                    `"${entry.location || ''}"`,
                    `"${entry.notes || ''}"`
                ].join(',')
            )
        ].join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }

    function exportToPDF(data, filename) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(12);
        doc.text('Registro Orario', 10, 10);
        doc.autoTable({
            head: [['Data', 'Inizio', 'Fine', 'Assenza', 'Ore Totali', 'Ore Straordinarie', 'Modalità', 'Luogo', 'Note']],
            body: data.map(entry => [
                formatDate(entry.date),
                entry.startTime || '',
                entry.endTime || '',
                entry.absenceType || '',
                entry.totalHours.toFixed(2),
                ((entry.overtimeHours || 0) + (entry.overtimeHours50 || 0)).toFixed(2),
                entry.workMode || '',
                entry.location || '',
                entry.notes || ''
            ]),
            startY: 20,
            margin: { top: 20 },
            styles: { overflow: 'linebreak', columnWidth: 'wrap' }
        });
        doc.save(filename);
    }

    function exportGrossNetToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(12);
        doc.text('Riepilogo Lordo/Netto', 10, 10);
        doc.autoTable({
            head: [['Mese', 'Lordo (€)', 'Netto (stimato) (€)', 'Straordinari (€)', 'Diarie (€)', 'Detrazioni (€)']],
            body: Array.from(grossNetBody.querySelectorAll('tr')).map(row =>
                Array.from(row.cells).map(cell => cell.textContent)
            ),
            startY: 20,
            margin: { top: 20 },
            styles: { overflow: 'linebreak', columnWidth: 'wrap' }
        });
        doc.save('Riepilogo_Lordo_Netto.pdf');
    }

    function exportBackup() {
        const grossNetSummary = {};
        registerData.forEach(entry => {
            const date = new Date(entry.date);
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            if (!grossNetSummary[year]) grossNetSummary[year] = {};
            if (!grossNetSummary[year][month]) {
                grossNetSummary[year][month] = { gross: 0, net: 0, overtime: 0, allowances: 0, deductions: 0 };
            }
            const economicValues = entry.economicValues || {
                grossBaseSalary,
                overtimeRate,
                overtimeRate50,
                tripAllowanceReturn,
                tripAllowanceOvernight,
                tripAllowanceAbroad,
                taxRate,
                thirteenthMonth
            };
            const monthlyHours = entry.totalHours || 0;
            const overtimeHours = entry.overtimeHours || 0;
            const overtimeHours50 = entry.overtimeHours50 || 0;
            const allowance = entry.workMode === 'Rientro' ? economicValues.tripAllowanceReturn :
                            entry.workMode === 'Pernottamento' ? economicValues.tripAllowanceOvernight :
                            entry.workMode === 'Estero' ? economicValues.tripAllowanceAbroad : 0;

            const baseSalaryPerHour = economicValues.grossBaseSalary / (20 * 8);
            const grossBase = (monthlyHours - overtimeHours) * baseSalaryPerHour;
            const grossOvertime = overtimeHours * economicValues.overtimeRate + overtimeHours50 * economicValues.overtimeRate50;
            const grossTotal = grossBase + grossOvertime + allowance + (economicValues.thirteenthMonth / 12);
            const deductions = grossTotal * (economicValues.taxRate + socialSecurityRate);
            const netTotal = grossTotal - deductions;

            grossNetSummary[year][month].gross += grossTotal;
            grossNetSummary[year][month].net += netTotal;
            grossNetSummary[year][month].overtime += grossOvertime;
            grossNetSummary[year][month].allowances += allowance;
            grossNetSummary[year][month].deductions += deductions;
        });

        const backupData = { registerData, grossNetSummary, settings: {
            grossBaseSalary,
            overtimeRate,
            overtimeRate50,
            tripAllowanceReturn,
            tripAllowanceOvernight,
            tripAllowanceAbroad,
            taxRate,
            thirteenthMonth
        }};
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "backup_registro.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
        showNotification('Backup creato con successo!', 'success');
    }

    function importBackup(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    registerData = data.registerData || [];
                    const grossNetSummary = data.grossNetSummary || {};
                    const settings = data.settings || {};
                    grossBaseSalary = settings.grossBaseSalary || photoData.grossBaseSalary;
                    overtimeRate = settings.overtimeRate || photoData.overtimeRate;
                    overtimeRate50 = settings.overtimeRate50 || photoData.overtimeRate50;
                    tripAllowanceReturn = settings.tripAllowanceReturn || photoData.tripAllowanceReturn;
                    tripAllowanceOvernight = settings.tripAllowanceOvernight || photoData.tripAllowanceOvernight;
                    tripAllowanceAbroad = settings.tripAllowanceAbroad || photoData.tripAllowanceAbroad;
                    taxRate = settings.taxRate || photoData.taxRate;
                    thirteenthMonth = settings.thirteenthMonth || photoData.thirteenthMonth;
                    
                    grossBaseSalaryInput.value = grossBaseSalary;
                    overtimeRateInput.value = overtimeRate;
                    overtimeRate50Input.value = overtimeRate50;
                    tripAllowanceReturnInput.value = tripAllowanceReturn;
                    tripAllowanceOvernightInput.value = tripAllowanceOvernight;
                    tripAllowanceAbroadInput.value = tripAllowanceAbroad;
                    taxRateInput.value = taxRate * 100;
                    thirteenthMonthInput.value = thirteenthMonth;

                    localStorage.setItem(STORAGE_KEY, JSON.stringify(registerData));
                    localStorage.setItem(SETTINGS_KEY, JSON.stringify({
                        grossBaseSalary,
                        overtimeRate,
                        overtimeRate50,
                        tripAllowanceReturn,
                        tripAllowanceOvernight,
                        tripAllowanceAbroad,
                        taxRate,
                        thirteenthMonth
                    }));
                    renderAllData();
                    showNotification('Backup importato con successo!', 'success');
                } catch (e) {
                    showNotification('Errore nell\'importazione del backup.', 'error');
                    console.error(e);
                }
            };
            reader.readAsText(file);
        }
        importFile.value = '';
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
        generateTimeOptions();
        loadData();
        renderAllData();

        startTimeDisplay.addEventListener('click', () => {
            startTimeOptions.classList.toggle('visible');
            endTimeOptions.classList.remove('visible');
        });
        endTimeDisplay.addEventListener('click', () => {
            endTimeOptions.classList.toggle('visible');
            startTimeOptions.classList.remove('visible');
        });

        startTimeOptions.querySelectorAll('.time-option').forEach(option => {
            option.addEventListener('click', () => {
                setTimeDropdown(startTimeDisplay, startTimeOptions, option.getAttribute('data-value'));
                startTimeOptions.classList.remove('visible');
                calculateHours();
            });
        });
        endTimeOptions.querySelectorAll('.time-option').forEach(option => {
            option.addEventListener('click', () => {
                setTimeDropdown(endTimeDisplay, endTimeOptions, option.getAttribute('data-value'));
                endTimeOptions.classList.remove('visible');
                calculateHours();
            });
        });

        [workModeSelect, absenceTypeSelect, dateInput, lunchBreakCheckbox, locationInput, notesInput].forEach(element => {
            element.addEventListener('change', calculateHours);
        });

        saveButton.addEventListener('click', saveEntry);

        registerBody.addEventListener('click', (e) => {
            if (e.target.closest('.btn-delete')) {
                const date = e.target.closest('button').getAttribute('data-date');
                deleteEntry(date);
            } else if (e.target.closest('.btn-edit')) {
                const date = e.target.closest('button').getAttribute('data-date');
                editEntry(date);
            }
        });

        toggleRegisterHeader.addEventListener('click', () => {
            toggleRegisterHeader.classList.toggle('open');
            registerContent.classList.toggle('open');
        });

        toggleSettingsHeader.addEventListener('click', () => {
            toggleSettingsHeader.classList.toggle('open');
            settingsContent.classList.toggle('open');
        });

        toggleGrossNetHeader.addEventListener('click', () => {
            toggleGrossNetHeader.classList.toggle('open');
            grossNetContent.classList.toggle('open');
        });

        searchInput.addEventListener('input', () => {
            const query = searchInput.value.toLowerCase();
            registerBody.querySelectorAll('tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query) ? '' : 'none';
            });
        });

        filterYearSelect.addEventListener('change', filterRegister);

        exportSelectedButton.addEventListener('click', () => {
            const year = exportYearSelect.value;
            const selectedMonths = Array.from(multiselectMonthOptions.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
            const filteredData = registerData.filter(entry => {
                const date = new Date(entry.date);
                const entryYear = date.getFullYear();
                const entryMonth = date.getMonth() + 1;
                const matchesYear = !year || entryYear == year;
                const matchesMonth = selectedMonths.length === 0 || selectedMonths.includes(entryMonth.toString());
                return matchesYear && matchesMonth;
            });
            exportToCSV(filteredData, `registro_${year || 'tutto'}.csv`);
        });

        exportSelectedPdfButton.addEventListener('click', () => {
            const year = exportYearSelect.value;
            const selectedMonths = Array.from(multiselectMonthOptions.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
            const filteredData = registerData.filter(entry => {
                const date = new Date(entry.date);
                const entryYear = date.getFullYear();
                const entryMonth = date.getMonth() + 1;
                const matchesYear = !year || entryYear == year;
                const matchesMonth = selectedMonths.length === 0 || selectedMonths.includes(entryMonth.toString());
                return matchesYear && matchesMonth;
            });
            exportToPDF(filteredData, `registro_${year || 'tutto'}.pdf`);
        });

        exportAllButton.addEventListener('click', () => {
            exportToCSV(registerData, 'registro_tutto.csv');
        });

        exportPdfButton.addEventListener('click', () => {
            exportToPDF(registerData, 'registro_tutto.pdf');
        });

        exportGrossNetPdfButton.addEventListener('click', exportGrossNetToPDF);

        exportDataBtn.addEventListener('click', exportBackup);
        importDataBtn.addEventListener('click', () => importFile.click());
        importFile.addEventListener('change', importBackup);

        [grossBaseSalaryInput, overtimeRateInput, overtimeRate50Input, tripAllowanceReturnInput, tripAllowanceOvernightInput, tripAllowanceAbroadInput, taxRateInput, thirteenthMonthInput].forEach(input => {
            input.addEventListener('change', () => {
                grossBaseSalary = parseFloat(grossBaseSalaryInput.value) || photoData.grossBaseSalary;
                overtimeRate = parseFloat(overtimeRateInput.value) || photoData.overtimeRate;
                overtimeRate50 = parseFloat(overtimeRate50Input.value) || photoData.overtimeRate50;
                tripAllowanceReturn = parseFloat(tripAllowanceReturnInput.value) || photoData.tripAllowanceReturn;
                tripAllowanceOvernight = parseFloat(tripAllowanceOvernightInput.value) || photoData.tripAllowanceOvernight;
                tripAllowanceAbroad = parseFloat(tripAllowanceAbroadInput.value) || photoData.tripAllowanceAbroad;
                taxRate = parseFloat(taxRateInput.value) / 100 || photoData.taxRate;
                thirteenthMonth = parseFloat(thirteenthMonthInput.value) || photoData.thirteenthMonth;
                localStorage.setItem(SETTINGS_KEY, JSON.stringify({
                    grossBaseSalary,
                    overtimeRate,
                    overtimeRate50,
                    tripAllowanceReturn,
                    tripAllowanceOvernight,
                    tripAllowanceAbroad,
                    taxRate,
                    thirteenthMonth
                }));
                renderGrossNetSummary();
            });
        });
    });

    function loadData() {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (savedData) {
            registerData = JSON.parse(savedData);
        }
        const savedSettings = localStorage.getItem(SETTINGS_KEY);
        if (savedSettings) {
            const settings = JSON.parse(savedSettings);
            grossBaseSalary = settings.grossBaseSalary || photoData.grossBaseSalary;
            overtimeRate = settings.overtimeRate || photoData.overtimeRate;
            overtimeRate50 = settings.overtimeRate50 || photoData.overtimeRate50;
            tripAllowanceReturn = settings.tripAllowanceReturn || photoData.tripAllowanceReturn;
            tripAllowanceOvernight = settings.tripAllowanceOvernight || photoData.tripAllowanceOvernight;
            tripAllowanceAbroad = settings.tripAllowanceAbroad || photoData.tripAllowanceAbroad;
            taxRate = settings.taxRate || photoData.taxRate;
            thirteenthMonth = settings.thirteenthMonth || photoData.thirteenthMonth;
        } else {
            grossBaseSalary = photoData.grossBaseSalary;
            overtimeRate = photoData.overtimeRate;
            overtimeRate50 = photoData.overtimeRate50;
            tripAllowanceReturn = photoData.tripAllowanceReturn;
            tripAllowanceOvernight = photoData.tripAllowanceOvernight;
            tripAllowanceAbroad = photoData.tripAllowanceAbroad;
            taxRate = photoData.taxRate;
            thirteenthMonth = photoData.thirteenthMonth;
        }
        grossBaseSalaryInput.value = grossBaseSalary;
        overtimeRateInput.value = overtimeRate;
        overtimeRate50Input.value = overtimeRate50;
        tripAllowanceReturnInput.value = tripAllowanceReturn;
        tripAllowanceOvernightInput.value = tripAllowanceOvernight;
        tripAllowanceAbroadInput.value = tripAllowanceAbroad;
        taxRateInput.value = taxRate * 100;
        thirteenthMonthInput.value = thirteenthMonth;
    }
</script>
</body>
</html>
