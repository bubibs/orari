<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Orario Lavoro</title>
    <link rel="apple-touch-icon" href="img/apple-touch-icon.png">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f0f5;
            margin: 0;
            padding: 10px;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .logo-text {
            text-align: center;
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 15px;
            background: linear-gradient(to right, #ef5350, #f48fb1, #7e57c2, #2196f3, #26c6da, #43a047, #eeff41, #f9a825, #ff5722);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .auth-container {
            text-align: center;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .sync-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .sync-status.online {
            background-color: #d4edda;
            color: #155724;
        }
        .sync-status.offline {
            background-color: #f8d7da;
            color: #721c24;
        }
        h1, h2 {
            text-align: center;
            color: #00a2e3;
            margin-bottom: 15px;
        }
        h2 {
            margin-top: 30px;
        }
        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-bottom: 0;
            font-size: 1.2em;
        }
        .collapsible-header .arrow {
            margin-left: 8px;
            transition: transform 0.3s ease;
        }
        .collapsible-header.open .arrow {
            transform: rotate(180deg);
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }
        .collapsible-content.open {
            max-height: 2000px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 0.9em;
        }
        input[type="date"], input[type="text"], input[type="number"], input[type="email"], input[type="password"], textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            transition: box-shadow 0.3s ease, border-color 0.3s ease;
        }
        input[type="date"]:focus, input[type="text"]:focus, input[type="number"]:focus, input[type="email"]:focus, input[type="password"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #00a2e3;
            box-shadow: 0 0 0 3px rgba(0, 162, 227, 0.3);
        }
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        .time-dropdown-container {
            position: relative;
        }
        .time-display {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            background-color: #fff;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .time-dropdown-container:focus-within .time-display {
            border-color: #00a2e3;
            box-shadow: 0 0 0 3px rgba(0, 162, 227, 0.3);
        }
        .time-display:after {
            content: '‚ñº';
            font-size: 12px;
        }
        .time-options {
            position: absolute;
            width: 100%;
            max-height: 200px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #fff;
            z-index: 10;
            margin-top: 4px;
            display: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .time-options.visible {
            display: block;
        }
        .time-option {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .time-option:hover {
            background-color: #f0f0f5;
        }
        .time-option.selected {
            background-color: #e6f7ff;
            font-weight: 600;
        }
        .radio-group, .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .radio-group label, .checkbox-group label {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 0;
        }
        .radio-group input, .checkbox-group input {
            width: auto;
            margin-right: 8px;
            -webkit-appearance: radio;
            -moz-appearance: radio;
            appearance: radio;
        }
        .btn {
            display: block;
            width: 100%;
            padding: 12px;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-small {
            padding: 5px 8px;
            font-size: 12px;
            margin: 0;
            display: inline-block;
            width: auto;
            border-radius: 6px;
        }
        .btn-delete {
            background-color: #f08080;
        }
        .btn-delete:hover {
            background-color: #e06666;
        }
        .btn-edit {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-edit:hover {
            background-color: #e0a800;
        }
        .btn-auth {
            background-color: #28a745;
        }
        .btn-auth:hover {
            background-color: #218838;
        }
        .btn-logout {
            background-color: #dc3545;
        }
        .btn-logout:hover {
            background-color: #c82333;
        }
        #save-btn {
            background-color: #00a2e3;
            font-size: 20px;
            position: relative;
        }
        #save-btn:hover {
            background-color: #007bb6;
        }
        .btn-save-anim {
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .btn-save-anim .btn-text, .btn-save-anim .btn-icon {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .btn-save-anim .btn-text {
            position: absolute;
            opacity: 1;
            transform: translateY(0);
        }
        .btn-save-anim .btn-icon {
            position: absolute;
            opacity: 0;
            transform: translateY(100%);
        }
        .btn-save-anim.saved .btn-text {
            opacity: 0;
            transform: translateY(-100%);
        }
        .btn-save-anim.saved .btn-icon {
            opacity: 1;
            transform: translateY(0);
        }
        .btn-green {
            background-color: #22a36b;
        }
        .btn-green:hover {
            background-color: #1a7e52;
        }
        .btn-pdf {
            background-color: #b30000;
        }
        .btn-pdf:hover {
            background-color: #800000;
        }
        .btn-backup {
            background-color: #337ab7;
        }
        .btn-backup:hover {
            background-color: #286090;
        }
        .button-group-responsive {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        #results {
            margin-top: 20px;
            padding: 12px;
            background-color: #e9ecef;
            border-radius: 8px;
        }
        #results h3 {
            margin-top: 0;
            color: #00a2e3;
            font-size: 1.1em;
        }
        #results p {
            margin: 4px 0;
            font-size: 16px;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: #fff;
            font-size: 12px;
        }
        th, td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            white-space: nowrap;
        }
        th:last-child {
            text-align: center;
        }
        td:first-child {
            white-space: nowrap;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        #register-table tbody tr {
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInRow 0.5s ease-out forwards;
        }
        @keyframes fadeInRow {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .action-buttons-cell {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }
        #notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            opacity: 0;
            transform: translateY(100px);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        #notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        #notification.success {
            background-color: #28a745;
        }
        #notification.error {
            background-color: #dc3545;
        }
        .export-options-container {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: flex-start;
        }
        .export-options-container > select {
            width: 45%;
        }
        .export-options-container > .multiselect-dropdown {
            width: 45%;
        }
        select {
            padding: 0 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: #fff;
            height: 40px;
        }
        .multiselect-dropdown {
            position: relative;
            cursor: pointer;
            user-select: none;
        }
        .multiselect-selected {
            width: 100%;
            padding: 0 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #fff;
            height: 40px;
            font-size: 14px;
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
            gap: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            line-height: 40px;
            transition: box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .multiselect-selected:after {
            content: '‚ñº';
            font-size: 12px;
            margin-left: auto;
            flex-shrink: 0;
        }
        .multiselect-options {
            position: absolute;
            width: 100%;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #fff;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
            box-sizing: border-box;
        }
        .multiselect-options.visible {
            display: block;
        }
        .multiselect-option {
            padding: 10px;
            display: flex;
            align-items: center;
        }
        .multiselect-option input[type="checkbox"] {
            margin-right: 10px;
            -webkit-appearance: checkbox;
        }
        .multiselect-option:hover {
            background-color: #f0f0f5;
        }
        .multiselect-dropdown.disabled {
            opacity: 0.6;
            pointer-events: none;
        }
        .chart-container {
            margin: 20px 0;
            text-align: center;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }
        .hidden {
            display: none;
        }
        @media (min-width: 600px) {
            .multiselect-selected,
            .export-options-container > select {
                font-size: 16px;
                height: 48px;
                line-height: 48px;
            }
            .multiselect-option {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="logo-text">TECNOSISTEM</div>
    
    <!-- Informazioni utente e stato sincronizzazione -->
    <div id="user-info" class="user-info">
        <div>
            <span>Utente: </span><span id="user-email">Caricamento...</span>
        </div>
        <div>
            <span id="sync-status" class="sync-status offline">Offline</span>
            <button id="logout-btn" class="btn btn-logout" style="width: auto; padding: 8px 16px; margin: 0 0 0 10px;">Esci</button>
        </div>
    </div>

    <!-- Contenuto principale -->
    <div id="main-content">
        <div class="loading" id="loading">Caricamento dati...</div>
        
        <div id="app-content" class="hidden">
            <div class="form-group">
                <label for="date">Seleziona Giorno:</label>
                <input type="date" id="date">
            </div>

            <div class="form-group">
                <label for="workModeSelect">Modalit√† di lavoro:</label>
                <select id="workModeSelect">
                    <option value="">Seleziona...</option>
                    <option value="In Sede">In sede</option>
                    <option value="Rientro">Trasferta (Rientro)</option>
                    <option value="Pernottamento">Trasferta (Pernottamento)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="absenceType">Tipo di Assenza:</label>
                <select id="absenceType">
                    <option value="">Nessuna assenza</option>
                    <option value="Ferie">Ferie</option>
                    <option value="Permesso">Permesso</option>
                    <option value="Malattia">Malattia</option>
                </select>
            </div>

            <div id="work-fields">
                <div class="form-group">
                    <label>Orario Inizio:</label>
                    <div class="time-dropdown-container">
                        <div id="startTimeDisplay" class="time-display" data-value="">Seleziona orario</div>
                        <div id="startTimeOptions" class="time-options"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Orario Fine:</label>
                    <div class="time-dropdown-container">
                        <div id="endTimeDisplay" class="time-display" data-value="">Seleziona orario</div>
                        <div id="endTimeOptions" class="time-options"></div>
                    </div>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="lunchBreak">
                    <label for="lunchBreak">Pausa pranzo (1 ora)</label>
                </div>
            </div>

            <div class="form-group">
                <label for="location">Luogo Intervento:</label>
                <input type="text" id="location" list="location-suggestions">
                <datalist id="location-suggestions"></datalist>
            </div>
            <div class="form-group">
                <label for="notes">Note:</label>
                <textarea id="notes"></textarea>
            </div>
            
            <div id="results">
                <h3>Riepilogo giornaliero</h3>
                <p id="totalHoursContainer"><strong>Ore totali:</strong> <span id="totalHours">0</span></p>
                <p id="overtimeHoursContainer"><strong>Ore straordinarie:</strong> <span id="overtimeHours">0</span></p>
                <p id="absenceHoursContainer" style="display: none;"><strong>Ore di assenza:</strong> <span id="absenceHours">0</span></p>
            </div>
            
            <button id="save-btn" class="btn btn-save-anim">
                <span class="btn-text">üíæ Salva</span>
                <span class="btn-icon">‚úÖ</span>
            </button>
            
            <hr>
            
            <h2>Riepilogo Mensile</h2>
            <div class="chart-container">
                <canvas id="monthlyChart"></canvas>
            </div>
            
            <div class="table-container">
                <table id="monthly-summary-table">
                    <thead>
                        <tr>
                            <th>Mese</th>
                            <th>Ore Tot.</th>
                            <th>Ore Str.</th>
                            <th>Trasferta</th>
                            <th>Sede</th>
                            <th>Assenze</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            
            <hr>
            
            <h2 class="collapsible-header" id="toggle-settings">‚öôÔ∏è Impostazioni Avanzate <span class="arrow">‚ñº</span></h2>
            <div class="collapsible-content" id="settings-content">
                <p>Modifica i valori usati per i calcoli economici. I cambiamenti verranno salvati automaticamente su Firebase.</p>
                <div class="form-group">
                    <label for="grossBaseSalaryInput">Paga Base Mensile Lorda (‚Ç¨):</label>
                    <input type="number" id="grossBaseSalaryInput" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="overtimeRateInput">Paga Oraria Straordinario (‚Ç¨):</label>
                    <input type="number" id="overtimeRateInput" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="tripAllowanceReturnInput">Diaria Trasferta Rientro (‚Ç¨):</label>
                    <input type="number" id="tripAllowanceReturnInput" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="tripAllowanceOvernightInput">Diaria Trasferta Pernottamento (‚Ç¨):</label>
                    <input type="number" id="tripAllowanceOvernightInput" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="taxRateInput">Aliquota Fiscale (IRPEF, ecc.) in %:</label>
                    <input type="number" id="taxRateInput" step="0.1" min="0" max="100">
                </div>
            </div>
            
            <hr>
            
            <h2 class="collapsible-header" id="toggle-gross-net">üí∞ Riepilogo Lordo/Netto <span class="arrow">‚ñº</span></h2>
            <div class="collapsible-content" id="gross-net-content">
                <div class="table-container">
                    <table id="gross-net-table">
                        <thead>
                            <tr>
                                <th>Mese</th>
                                <th>Lordo</th>
                                <th>Netto (stimato)</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <hr>
            
            <h2 class="collapsible-header" id="toggle-register">Registro Completo <span class="arrow">‚ñº</span></h2>
            <div class="collapsible-content" id="register-content">
                <div class="form-group" style="margin-top: 20px;">
                    <label for="search-input">Cerca nel registro:</label>
                    <input type="text" id="search-input" placeholder="Cerca per data, luogo o note...">
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label for="filter-month-year">Filtra per Mese(i) o Anno:</label>
                    <div class="export-options-container">
                        <select id="filter-year">
                            <option value="">Tutti gli Anni</option>
                        </select>
                        <div class="multiselect-dropdown" id="filter-month-container">
                            <div class="multiselect-selected">Tutti i Mesi</div>
                            <div class="multiselect-options" id="filter-month-options"></div>
                        </div>
                    </div>
                </div>
                <div class="table-container">
                    <table id="register-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Inizio</th>
                                <th>Fine</th>
                                <th>Assenza</th>
                                <th>Totali</th>
                                <th>Str.</th>
                                <th>Modalit√†</th>
                                <th>Luogo</th>
                                <th>Note</th>
                                <th>Azione</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <hr>
            
            <h2>Esporta e gestisci i dati</h2>
            
            <div class="form-group" style="margin-top: 20px;">
                <label>Esporta un periodo specifico:</label>
                <div class="export-options-container">
                    <select id="export-year">
                        <option value="">Seleziona Anno</option>
                    </select>
                    <div class="multiselect-dropdown" id="multiselect-month-container">
                        <div class="multiselect-selected">Seleziona Mese(i)</div>
                        <div class="multiselect-options" id="multiselect-month-options"></div>
                    </div>
                </div>
            </div>
            <div class="button-group-responsive">
                <button id="export-selected-btn" class="btn btn-green">Esporta in CSV</button>
                <button id="export-selected-pdf-btn" class="btn btn-pdf">Esporta in PDF</button>
            </div>
            <div class="button-group-responsive">
                <button id="export-all-btn" class="btn btn-green">Esporta tutto in CSV</button>
                <button id="export-pdf-btn" class="btn btn-pdf">Esporta tutto in PDF</button>
            </div>
            
            <div class="button-group-responsive" style="margin-top: 20px;">
                <button id="export-data-btn" class="btn btn-backup">Crea Backup</button>
                <button id="import-data-btn" class="btn btn-backup">Importa Backup</button>
                <input type="file" id="import-file" accept=".json" style="display: none;">
            </div>
        </div>
    </div>
</div>

<div id="notification"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase SDK -->
<script type="module">
    // Importa le funzioni Firebase
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { 
        getAuth, 
        createUserWithEmailAndPassword, 
        signInWithEmailAndPassword, 
        signOut, 
        onAuthStateChanged 
    } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { 
        getFirestore, 
        collection, 
        doc, 
        setDoc, 
        getDoc, 
        getDocs, 
        deleteDoc, 
        onSnapshot,
        serverTimestamp,
        orderBy,
        query
    } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

    // Configurazione Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyB8gbRE-a8U7ed9IuHIXgxWFj-PEe6_Vg4",
        authDomain: "orari-ts.firebaseapp.com",
        databaseURL: "https://orari-ts-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "orari-ts",
        storageBucket: "orari-ts.firebasestorage.app",
        messagingSenderId: "375795078333",
        appId: "1:375795078333:web:803f281017af9144e813d4",
        measurementId: "G-J2H4KV35T1"
    };

    // Inizializza Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Elementi DOM
    const userEmailSpan = document.getElementById('user-email');
    const syncStatusSpan = document.getElementById('sync-status');
    const logoutBtn = document.getElementById('logout-btn');
    const loading = document.getElementById('loading');
    const appContent = document.getElementById('app-content');
    const dateInput = document.getElementById('date');
    const workModeSelect = document.getElementById('workModeSelect');
    const absenceTypeSelect = document.getElementById('absenceType');
    const workFields = document.getElementById('work-fields');
    const startTimeDisplay = document.getElementById('startTimeDisplay');
    const startTimeOptions = document.getElementById('startTimeOptions');
    const endTimeDisplay = document.getElementById('endTimeDisplay');
    const endTimeOptions = document.getElementById('endTimeOptions');
    const lunchBreakCheckbox = document.getElementById('lunchBreak');
    const locationInput = document.getElementById('location');
    const notesInput = document.getElementById('notes');
    const totalHoursSpan = document.getElementById('totalHours');
    const overtimeHoursSpan = document.getElementById('overtimeHours');
    const absenceHoursSpan = document.getElementById('absenceHours');
    const totalHoursContainer = document.getElementById('totalHoursContainer');
    const overtimeHoursContainer = document.getElementById('overtimeHoursContainer');
    const absenceHoursContainer = document.getElementById('absenceHoursContainer');
    const saveButton = document.getElementById('save-btn');
    const registerBody = document.querySelector('#register-table tbody');
    const monthlySummaryBody = document.querySelector('#monthly-summary-table tbody');
    const locationDatalist = document.getElementById('location-suggestions');
    const toggleRegisterHeader = document.getElementById('toggle-register');
    const registerContent = document.getElementById('register-content');
    const notification = document.getElementById('notification');
    const searchInput = document.getElementById('search-input');
    
    // Variabili globali
    const standardWorkDay = 8;
    const standardStartTime = '08:00';
    const standardEndTime = '17:00';
    let registerData = [];
    let currentUser = null;
    let unsubscribeRegister = null;
    let unsubscribeSettings = null;
    
    // Variabili per i calcoli economici (ora personalizzabili)
    let grossBaseSalary = 3480.79;
    let overtimeRate = 21.53;
    let tripAllowanceReturn = 46.48;
    let tripAllowanceOvernight = 60.00;
    let taxRate = 0.30;
    const socialSecurityRate = 0.0949;
    
    // Elementi del menu impostazioni
    const toggleSettingsHeader = document.getElementById('toggle-settings');
    const settingsContent = document.getElementById('settings-content');
    const grossBaseSalaryInput = document.getElementById('grossBaseSalaryInput');
    const overtimeRateInput = document.getElementById('overtimeRateInput');
    const tripAllowanceReturnInput = document.getElementById('tripAllowanceReturnInput');
    const tripAllowanceOvernightInput = document.getElementById('tripAllowanceOvernightInput');
    const taxRateInput = document.getElementById('taxRateInput');

    // Elementi di esportazione e filtro
    const exportYearSelect = document.getElementById('export-year');
    const multiselectMonthContainer = document.getElementById('multiselect-month-container');
    const multiselectMonthSelected = document.querySelector('#multiselect-month-container .multiselect-selected');
    const multiselectMonthOptions = document.getElementById('multiselect-month-options');
    const exportSelectedButton = document.getElementById('export-selected-btn');
    const exportSelectedPdfButton = document.getElementById('export-selected-pdf-btn');
    const exportAllButton = document.getElementById('export-all-btn');
    const exportPdfButton = document.getElementById('export-pdf-btn');
    const filterYearSelect = document.getElementById('filter-year');
    const filterMonthContainer = document.getElementById('filter-month-container');
    const filterMonthSelected = document.querySelector('#filter-month-container .multiselect-selected');
    const filterMonthOptions = document.getElementById('filter-month-options');
    const exportDataBtn = document.getElementById('export-data-btn');
    const importDataBtn = document.getElementById('import-data-btn');
    const importFile = document.getElementById('import-file');
    
    // Elementi del grafico
    const monthlyChartCanvas = document.getElementById('monthlyChart');
    let monthlyChart = null;

    // Elementi del riepilogo lordo/netto
    const toggleGrossNetHeader = document.getElementById('toggle-gross-net');
    const grossNetContent = document.getElementById('gross-net-content');
    const grossNetBody = document.querySelector('#gross-net-table tbody');

    // Funzioni di utilit√†
    function showNotification(message, type) {
        notification.innerHTML = message;
        notification.className = '';
        notification.classList.add('show', type);
        setTimeout(() => {
            notification.classList.remove('show');
        }, 8000);
    }

    function updateSyncStatus(isOnline) {
        if (isOnline) {
            syncStatusSpan.textContent = 'Online';
            syncStatusSpan.className = 'sync-status online';
        } else {
            syncStatusSpan.textContent = 'Offline';
            syncStatusSpan.className = 'sync-status offline';
        }
    }

    // Controlla lo stato di autenticazione
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            userEmailSpan.textContent = user.email || 'Utente anonimo';
            updateSyncStatus(true);
            
            // Carica i dati dell'utente
            await loadUserData();
            
            // Mostra il contenuto dell'app
            loading.classList.add('hidden');
            appContent.classList.remove('hidden');
        } else {
            // Se l'utente non √® autenticato, reindirizza alla pagina di login
            window.location.href = 'index.html';
        }
    });

    // Funzione per caricare i dati dell'utente da Firebase
    async function loadUserData() {
        if (!currentUser) return;

        try {
            // Carica le impostazioni
            const settingsRef = doc(db, 'users', currentUser.uid, 'settings', 'main');
            unsubscribeSettings = onSnapshot(settingsRef, (doc) => {
                if (doc.exists()) {
                    const settings = doc.data();
                    grossBaseSalary = settings.grossBaseSalary || grossBaseSalary;
                    overtimeRate = settings.overtimeRate || overtimeRate;
                    tripAllowanceReturn = settings.tripAllowanceReturn || tripAllowanceReturn;
                    tripAllowanceOvernight = settings.tripAllowanceOvernight || tripAllowanceOvernight;
                    taxRate = settings.taxRate || taxRate;
                    
                    // Aggiorna i campi input
                    loadSettingsToInputs();
                }
                calculateGrossNetSummary();
            });

            // Carica i dati del registro in tempo reale
            const registerRef = collection(db, 'users', currentUser.uid, 'register');
            const registerQuery = query(registerRef, orderBy('date', 'desc'));
            
            unsubscribeRegister = onSnapshot(registerQuery, (snapshot) => {
                registerData = [];
                snapshot.forEach((doc) => {
                    registerData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                renderAllData();
            });

        } catch (error) {
            console.error('Errore nel caricamento dei dati:', error);
            showNotification('Errore nel caricamento dei dati: ' + error.message, 'error');
        }
    }

    // Funzione per salvare le impostazioni su Firebase
    async function saveSettingsToFirebase() {
        if (!currentUser) return;

        const settings = {
            grossBaseSalary: parseFloat(grossBaseSalaryInput.value) || grossBaseSalary,
            overtimeRate: parseFloat(overtimeRateInput.value) || overtimeRate,
            tripAllowanceReturn: parseFloat(tripAllowanceReturnInput.value) || tripAllowanceReturn,
            tripAllowanceOvernight: parseFloat(tripAllowanceOvernightInput.value) || tripAllowanceOvernight,
            taxRate: parseFloat(taxRateInput.value) / 100 || taxRate,
            updatedAt: serverTimestamp()
        };

        try {
            const settingsRef = doc(db, 'users', currentUser.uid, 'settings', 'main');
            await setDoc(settingsRef, settings, { merge: true });
            showNotification('Impostazioni salvate su Firebase!', 'success');
        } catch (error) {
            console.error('Errore nel salvataggio delle impostazioni:', error);
            showNotification('Errore nel salvataggio: ' + error.message, 'error');
        }
    }

    // Funzione per caricare le impostazioni negli input
    function loadSettingsToInputs() {
        grossBaseSalaryInput.value = grossBaseSalary;
        overtimeRateInput.value = overtimeRate;
        tripAllowanceReturnInput.value = tripAllowanceReturn;
        tripAllowanceOvernightInput.value = tripAllowanceOvernight;
        taxRateInput.value = (taxRate * 100);
    }

    // Funzione per salvare un entry su Firebase
    async function saveEntryToFirebase(entry) {
        if (!currentUser) return;

        try {
            const registerRef = doc(db, 'users', currentUser.uid, 'register', entry.date);
            await setDoc(registerRef, {
                ...entry,
                updatedAt: serverTimestamp()
            });
            showNotification('Dati salvati su Firebase!', 'success');
        } catch (error) {
            console.error('Errore nel salvataggio:', error);
            showNotification('Errore nel salvataggio: ' + error.message, 'error');
        }
    }

    // Funzione per eliminare un entry da Firebase
    async function deleteEntryFromFirebase(date) {
        if (!currentUser) return;

        try {
            const registerRef = doc(db, 'users', currentUser.uid, 'register', date);
            await deleteDoc(registerRef);
            showNotification('Dato eliminato da Firebase!', 'success');
        } catch (error) {
            console.error('Errore nella eliminazione:', error);
            showNotification('Errore nella eliminazione: ' + error.message, 'error');
        }
    }

    // Logout
    logoutBtn.addEventListener('click', async () => {
        try {
            if (unsubscribeRegister) unsubscribeRegister();
            if (unsubscribeSettings) unsubscribeSettings();
            await signOut(auth);
            window.location.href = 'index.html';
        } catch (error) {
            console.error('Errore nel logout:', error);
            showNotification('Errore nel logout: ' + error.message, 'error');
        }
    });

    function generateTimeOptions() {
        let optionsHtml = '';
        for (let h = 0; h < 24; h++) {
            for (let m = 0; m < 60; m += 30) {
                const hour = String(h).padStart(2, '0');
                const minute = String(m).padStart(2, '0');
                const time = `${hour}:${minute}`;
                optionsHtml += `<div class="time-option" data-value="${time}">${time}</div>`;
            }
        }
        startTimeOptions.innerHTML = optionsHtml;
        endTimeOptions.innerHTML = optionsHtml;
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        const [year, month, day] = dateString.split('-');
        return `${day}-${month}-${year.substring(2)}`;
    }

    function setTimeDropdown(display, options, time) {
        display.textContent = time;
        display.setAttribute('data-value', time);
        options.querySelectorAll('.time-option').forEach(option => {
            if (option.getAttribute('data-value') === time) {
                option.classList.add('selected');
            } else {
                option.classList.remove('selected');
            }
        });
    }

    function clearTimeDropdowns() {
        setTimeDropdown(startTimeDisplay, startTimeOptions, 'Seleziona orario');
        startTimeDisplay.setAttribute('data-value', '');
        setTimeDropdown(endTimeDisplay, endTimeOptions, 'Seleziona orario');
        endTimeDisplay.setAttribute('data-value', '');
    }

    function calculateHours() {
        const absenceType = absenceTypeSelect.value;
        const startTime = startTimeDisplay.getAttribute('data-value');
        const endTime = endTimeDisplay.getAttribute('data-value');
        const lunchBreak = lunchBreakCheckbox.checked;

        if (absenceType) {
            totalHoursSpan.textContent = '0';
            overtimeHoursSpan.textContent = '0';
            absenceHoursSpan.textContent = '8';
            totalHoursContainer.style.display = 'none';
            overtimeHoursContainer.style.display = 'none';
            absenceHoursContainer.style.display = 'block';
        } else {
            totalHoursContainer.style.display = 'block';
            overtimeHoursContainer.style.display = 'block';
            absenceHoursContainer.style.display = 'none';
        }

        if (startTime && endTime) {
            const start = new Date(`2025-01-01T${startTime}:00`);
            const end = new Date(`2025-01-01T${endTime}:00`);
            if (end < start) {
                end.setDate(end.getDate() + 1);
            }
            let totalMilliseconds = end - start;
            let totalHours = totalMilliseconds / (1000 * 60 * 60);
            if (lunchBreak) {
                totalHours -= 1;
            }
            const totalHoursFixed = totalHours.toFixed(2);
            let overtimeHours = 0;
            if (totalHours > standardWorkDay) {
                overtimeHours = totalHours - standardWorkDay;
            }
            totalHoursSpan.textContent = totalHoursFixed;
            overtimeHoursSpan.textContent = overtimeHours.toFixed(2);
        } else {
            totalHoursSpan.textContent = '0';
            overtimeHoursSpan.textContent = '0';
        }
    }

    function createRow(entry) {
        const row = document.createElement('tr');
        row.setAttribute('data-date', entry.date);
        row.innerHTML = `
            <td>${formatDate(entry.date)}</td>
            <td>${entry.startTime || '-'}</td>
            <td>${entry.endTime || '-'}</td>
            <td>${entry.absenceType || '-'}</td>
            <td>${entry.totalHours.toFixed(2)}</td>
            <td>${entry.overtimeHours.toFixed(2)}</td>
            <td>${entry.workMode || '-'}</td>
            <td>${entry.location}</td>
            <td>${entry.notes || ''}</td>
            <td class="action-buttons-cell">
                <button class="btn-small btn-edit" data-date="${entry.date}">‚úèÔ∏è</button>
                <button class="btn-small btn-delete" data-date="${entry.date}">üóëÔ∏è</button>
            </td>
        `;
        return row;
    }

    async function saveEntry() {
        const date = dateInput.value;
        const absenceType = absenceTypeSelect.value;
        const workMode = workModeSelect.value;
        let startTime, endTime, lunchBreak, location, notes, totalHours, overtimeHours, absenceHours;

        if (!date) {
            showNotification('Per favore, seleziona una data.', 'error');
            return;
        }

        if (absenceType) {
            startTime = standardStartTime;
            endTime = standardEndTime;
            lunchBreak = true;
            location = locationInput.value;
            notes = notesInput.value;
            totalHours = 0;
            overtimeHours = 0;
            absenceHours = 8;
        } else {
            startTime = startTimeDisplay.getAttribute('data-value');
            endTime = endTimeDisplay.getAttribute('data-value');
            lunchBreak = lunchBreakCheckbox.checked;
            location = locationInput.value;
            notes = notesInput.value;
            totalHours = parseFloat(totalHoursSpan.textContent);
            overtimeHours = parseFloat(overtimeHoursSpan.textContent);
            absenceHours = 0;
            
            if (!startTime || !endTime || !workMode) {
                showNotification('Per favore, compila tutti i campi richiesti.', 'error');
                return;
            }
            const start = new Date(`2025-01-01T${startTime}:00`);
            const end = new Date(`2025-01-01T${endTime}:00`);
            if (end < start) {
                showNotification('L\'orario di fine non pu√≤ essere precedente a quello di inizio.', 'error');
                return;
            }
        }
        
        saveButton.classList.add('saved');

        const newEntry = {
            date: date,
            startTime: startTime,
            endTime: endTime,
            totalHours: totalHours,
            overtimeHours: overtimeHours,
            workMode: workMode,
            lunchBreak: lunchBreak,
            location: location,
            notes: notes,
            absenceType: absenceType,
            absenceHours: absenceHours
        };

        // Salva su Firebase
        await saveEntryToFirebase(newEntry);
        
        setTimeout(() => {
            saveButton.classList.remove('saved');
            dateInput.value = new Date().toISOString().split('T')[0];
            workModeSelect.value = '';
            absenceTypeSelect.value = '';
            clearTimeDropdowns();
            lunchBreakCheckbox.checked = false;
            locationInput.value = '';
            notesInput.value = '';
            calculateHours();
        }, 1000);
    }

    async function deleteEntry(date) {
        if (confirm(`Sei sicuro di voler cancellare l'inserimento del giorno ${formatDate(date)}?`)) {
            await deleteEntryFromFirebase(date);
        }
    }

    function editEntry(date) {
        const entryToEdit = registerData.find(entry => entry.date === date);
        if (entryToEdit) {
            dateInput.value = entryToEdit.date;
            workModeSelect.value = entryToEdit.workMode || '';
            absenceTypeSelect.value = entryToEdit.absenceType || '';
            
            if (entryToEdit.startTime) {
                setTimeDropdown(startTimeDisplay, startTimeOptions, entryToEdit.startTime);
            }
            if (entryToEdit.endTime) {
                setTimeDropdown(endTimeDisplay, endTimeOptions, entryToEdit.endTime);
            }
            
            lunchBreakCheckbox.checked = entryToEdit.lunchBreak || false;
            locationInput.value = entryToEdit.location || '';
            notesInput.value = entryToEdit.notes || '';
            
            calculateHours();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    function renderRegisterTable(data) {
        registerBody.innerHTML = '';
        if (data.length === 0) {
            const noDataRow = document.createElement('tr');
            noDataRow.innerHTML = `<td colspan="10" style="text-align:center;">Nessun dato presente nel registro.</td>`;
            registerBody.appendChild(noDataRow);
            return;
        }
        data.forEach(entry => {
            const row = createRow(entry);
            registerBody.appendChild(row);
        });
    }

    function updateMonthlySummary() {
        const monthlySummary = {};
        const locations = new Set();
        registerData.forEach(entry => {
            const monthYear = entry.date.substring(0, 7);
            if (!monthlySummary[monthYear]) {
                monthlySummary[monthYear] = {
                    totalHours: 0,
                    overtimeHours: 0,
                    onSiteCount: 0,
                    returnTripCount: 0,
                    overnightTripCount: 0,
                    absenceCount: 0
                };
            }
            monthlySummary[monthYear].totalHours += entry.totalHours;
            monthlySummary[monthYear].overtimeHours += entry.overtimeHours;
            if (entry.workMode === 'In Sede') monthlySummary[monthYear].onSiteCount++;
            if (entry.workMode === 'Rientro') monthlySummary[monthYear].returnTripCount++;
            if (entry.workMode === 'Pernottamento') monthlySummary[monthYear].overnightTripCount++;
            if (entry.absenceType) monthlySummary[monthYear].absenceCount++;
            if (entry.location) locations.add(entry.location);
        });

        const sortedMonths = Object.keys(monthlySummary).sort().reverse();
        monthlySummaryBody.innerHTML = '';
        sortedMonths.forEach(monthYear => {
            const summary = monthlySummary[monthYear];
            const [year, month] = monthYear.split('-');
            const monthName = new Date(year, month - 1, 1).toLocaleString('it-IT', { month: 'long', year: 'numeric' });
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${monthName.charAt(0).toUpperCase() + monthName.slice(1)}</td>
                <td>${summary.totalHours.toFixed(2)}</td>
                <td>${summary.overtimeHours.toFixed(2)}</td>
                <td>${summary.returnTripCount + summary.overnightTripCount}</td>
                <td>${summary.onSiteCount}</td>
                <td>${summary.absenceCount}</td>
            `;
            monthlySummaryBody.appendChild(row);
        });

        const sortedLocations = [...locations].sort();
        locationDatalist.innerHTML = sortedLocations.map(loc => `<option value="${loc}"></option>`).join('');
        updateChart(monthlySummary);
    }

    function calculateGrossNetSummary() {
        const monthlySummary = {};
        registerData.forEach(entry => {
            const monthYear = entry.date.substring(0, 7);
            if (!monthlySummary[monthYear]) {
                monthlySummary[monthYear] = {
                    totalOvertimeHours: 0,
                    totalReturnTripCount: 0,
                    totalOvernightTripCount: 0
                };
            }
            monthlySummary[monthYear].totalOvertimeHours += entry.overtimeHours;
            if (entry.workMode === 'Rientro') monthlySummary[monthYear].totalReturnTripCount++;
            if (entry.workMode === 'Pernottamento') monthlySummary[monthYear].totalOvernightTripCount++;
        });

        const sortedMonths = Object.keys(monthlySummary).sort().reverse();
        grossNetBody.innerHTML = '';
        sortedMonths.forEach(monthYear => {
            const summary = monthlySummary[monthYear];
            const [year, month] = monthYear.split('-');
            const monthName = new Date(year, month - 1, 1).toLocaleString('it-IT', { month: 'long', year: 'numeric' });
            
            const grossOvertime = summary.totalOvertimeHours * overtimeRate;
            const grossReturnTripAllowance = summary.totalReturnTripCount * tripAllowanceReturn;
            const grossOvernightTripAllowance = summary.totalOvernightTripCount * tripAllowanceOvernight;
            
            const totalGross = grossBaseSalary + grossOvertime + grossReturnTripAllowance + grossOvernightTripAllowance;
            
            const afterSocialSecurity = totalGross - (totalGross * socialSecurityRate);
            const netIncome = afterSocialSecurity - (afterSocialSecurity * taxRate);
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${monthName.charAt(0).toUpperCase() + monthName.slice(1)}</td>
                <td>‚Ç¨ ${totalGross.toFixed(2)}</td>
                <td>‚Ç¨ ${netIncome.toFixed(2)}</td>
            `;
            grossNetBody.appendChild(row);
        });
    }

    function renderAllData() {
        renderRegisterTable(registerData);
        updateMonthlySummary();
        calculateGrossNetSummary();
        updateFilterOptions();
        updateExportOptions();
    }

    function updateChart(monthlySummary) {
        const sortedMonths = Object.keys(monthlySummary).sort();
        const labels = sortedMonths.map(monthYear => new Date(monthYear).toLocaleString('it-IT', { month: 'short', year: '2-digit' }));
        const onSiteCounts = sortedMonths.map(monthYear => monthlySummary[monthYear].onSiteCount);
        const tripCounts = sortedMonths.map(monthYear => monthlySummary[monthYear].returnTripCount + monthlySummary[monthYear].overnightTripCount);
        const absenceCounts = sortedMonths.map(monthYear => monthlySummary[monthYear].absenceCount);

        if (monthlyChart) {
            monthlyChart.destroy();
        }

        const data = {
            labels: labels,
            datasets: [{
                label: 'In Sede',
                data: onSiteCounts,
                backgroundColor: 'rgba(0, 162, 227, 0.7)',
                borderColor: 'rgba(0, 162, 227, 1)',
                borderWidth: 1
            },
            {
                label: 'Trasferta',
                data: tripCounts,
                backgroundColor: 'rgba(255, 165, 0, 0.7)',
                borderColor: 'rgba(255, 165, 0, 1)',
                borderWidth: 1
